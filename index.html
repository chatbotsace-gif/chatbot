<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistente Virtual</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
  background-size: 200% 200%;
  animation: gradientShift 15s ease infinite;
  color: #e2e8f0;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.header {
  padding: 16px 20px;
  background: linear-gradient(135deg, #1e40af, #3b82f6, #2563eb);
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.logo {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #60a5fa, #3b82f6);
  font-size: 22px;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
  animation: float 3s ease-in-out infinite;
  z-index: 1;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-5px); }
}

.header-title {
  flex: 1;
  z-index: 1;
}

.header-title h1 {
  font-size: 20px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.header-title p {
  font-size: 13px;
  opacity: 0.9;
  margin-top: 2px;
}

.status {
  font-size: 12px;
  padding: 6px 12px;
  border-radius: 20px;
  background: rgba(16, 185, 129, 0.25);
  border: 1px solid rgba(16, 185, 129, 0.4);
  z-index: 1;
  backdrop-filter: blur(10px);
}

.status-dot {
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
  display: inline-block;
  margin-right: 6px;
  animation: pulse 2s infinite;
  box-shadow: 0 0 8px #10b981;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.2); }
}

.quickActions {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 12px;
  background: rgba(15, 23, 42, 0.95);
  scrollbar-width: thin;
  border-bottom: 1px solid rgba(59, 130, 246, 0.2);
}

.quickActions::-webkit-scrollbar {
  height: 6px;
}

.quickActions::-webkit-scrollbar-thumb {
  background: rgba(59, 130, 246, 0.5);
  border-radius: 3px;
}

.quickActions button {
  padding: 10px 16px;
  border: none;
  border-radius: 20px;
  background: rgba(37, 99, 235, 0.25);
  color: #93c5fd;
  font-size: 13px;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.quickActions button:hover {
  background: rgba(59, 130, 246, 0.4);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.quickActions button:active {
  transform: translateY(0px);
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 16px 90px 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  scroll-behavior: smooth;
}

.messages::-webkit-scrollbar {
  width: 8px;
}

.messages::-webkit-scrollbar-track {
  background: rgba(15, 23, 42, 0.5);
}

.messages::-webkit-scrollbar-thumb {
  background: rgba(59, 130, 246, 0.5);
  border-radius: 4px;
}

.msg-wrapper {
  display: flex;
  gap: 12px;
  animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.msg-wrapper.me {
  flex-direction: row-reverse;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.avatar.user {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
}

.avatar.bot {
  background: linear-gradient(135deg, #06b6d4, #0891b2);
}

.msg {
  padding: 12px 16px;
  border-radius: 18px;
  max-width: 75%;
  font-size: 14px;
  line-height: 1.6;
  word-wrap: break-word;
  white-space: pre-line;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.msg-wrapper.me .msg {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  color: #fff;
  border-bottom-right-radius: 4px;
}

.msg-wrapper.bot .msg {
  background: rgba(30, 41, 59, 0.9);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-bottom-left-radius: 4px;
  backdrop-filter: blur(10px);
}

.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #3b82f6;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.7;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}

.inputArea {
  display: flex;
  padding: 12px;
  gap: 10px;
  background: rgba(15, 23, 42, 0.98);
  border-top: 1px solid rgba(59, 130, 246, 0.3);
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  backdrop-filter: blur(15px);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
}

.inputArea input {
  flex: 1;
  padding: 14px 18px;
  border-radius: 24px;
  border: 2px solid rgba(59, 130, 246, 0.4);
  background: rgba(30, 41, 59, 0.7);
  color: #e2e8f0;
  font-size: 14px;
  outline: none;
  transition: all 0.3s;
}

.inputArea input:focus {
  border-color: rgba(59, 130, 246, 0.8);
  background: rgba(30, 41, 59, 0.9);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.inputArea button {
  padding: 14px 20px;
  border: none;
  border-radius: 24px;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.inputArea button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
}

.inputArea button:active:not(:disabled) {
  transform: translateY(0px);
}

.inputArea button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#micBtn {
  background: linear-gradient(135deg, #10b981, #059669);
  min-width: 50px;
  font-size: 16px;
}

#micBtn.recording {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  animation: recordPulse 1s infinite;
}

@keyframes recordPulse {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
  }
  50% {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.8);
  }
}

.clear-btn {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  transition: all 0.3s;
  z-index: 10;
}

.clear-btn:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
}

@media (max-width: 600px) {
  .msg {
    max-width: 85%;
  }
  
  .header-title h1 {
    font-size: 16px;
  }
  
  .header-title p {
    font-size: 11px;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="logo">ğŸ¤–</div>
  <div class="header-title">
    <h1>Assistente Virtual Pro</h1>
    <p>Inteligente, rÃ¡pido e divertido!</p>
  </div>
  <div class="status"><span class="status-dot"></span>Online</div>
</div>

<div class="quickActions">
  <button onclick="sendQuick('Oi')">ğŸ‘‹ Saudar</button>
  <button onclick="sendQuick('Que horas sÃ£o?')">â° Hora</button>
  <button onclick="sendQuick('Qual a data?')">ğŸ“… Data</button>
  <button onclick="sendQuick('Me conte uma piada')">ğŸ˜„ Piada</button>
  <button onclick="sendQuick('50% de 200')">ğŸ§® Calcular</button>
  <button onclick="sendQuick('Qual a temperatura?')">ğŸŒ¡ï¸ Clima</button>
  <button onclick="sendQuick('Conte uma histÃ³ria')">ğŸ“– HistÃ³ria</button>
  <button onclick="sendQuick('Crie uma mÃºsica')">ğŸµ MÃºsica</button>
  <button onclick="sendQuick('Quem criou vocÃª?')">â„¹ï¸ Sobre</button>
</div>

<div id="messages" class="messages"></div>

<button class="clear-btn" onclick="clearChat()" title="Limpar chat">ğŸ—‘ï¸</button>

<div class="inputArea">
  <input id="inputMsg" placeholder="Digite sua mensagem..." autocomplete="off">
  <button id="micBtn">ğŸ¤</button>
  <button id="sendBtn">Enviar</button>
</div>

<script>
const messagesEl = document.getElementById('messages');
const input = document.getElementById('inputMsg');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');

const OPENWEATHER_API_KEY = '2cf489c19d902e5035391aa67d9ef883';

let userName = null;
let isProcessing = false;
let conversationState = 'IDLE';
let tempData = {};
let messageHistory = [];

// Carregar dados salvos
window.addEventListener('DOMContentLoaded', () => {
  const savedName = localStorage.getItem('userName');
  if (savedName) {
    userName = savedName;
  }
  
  const savedHistory = localStorage.getItem('chatHistory');
  if (savedHistory) {
    try {
      const history = JSON.parse(savedHistory);
      history.forEach(msg => {
        addMessage(msg.text, msg.who, false);
      });
    } catch (e) {
      console.error('Erro ao carregar histÃ³rico');
    }
  }
  
  if (messagesEl.children.length === 0) {
    addMessage("OlÃ¡! ğŸ‘‹ Sou seu assistente virtual. Como posso ajudar?", 'bot', false);
  }
});

// Adicionar mensagem
function addMessage(text, who = 'bot', shouldSave = true) {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrapper ' + who;
  
  const avatar = document.createElement('div');
  avatar.className = 'avatar ' + (who === 'me' ? 'user' : 'bot');
  avatar.textContent = who === 'me' ? 'ğŸ‘¤' : 'ğŸ¤–';
  
  const msg = document.createElement('div');
  msg.className = 'msg';
  msg.textContent = text;
  
  wrap.appendChild(avatar);
  wrap.appendChild(msg);
  messagesEl.appendChild(wrap);
  
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  if (shouldSave) {
    messageHistory.push({ text, who });
    if (messageHistory.length > 50) {
      messageHistory.shift();
    }
    localStorage.setItem('chatHistory', JSON.stringify(messageHistory));
  }
  
  if (who === 'bot') {
    speak(text);
  }
}

// Indicador de digitaÃ§Ã£o
function showTyping() {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrapper bot typing-wrapper';
  wrap.innerHTML = `
    <div class="avatar bot">ğŸ¤–</div>
    <div class="msg">
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  `;
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return wrap;
}

function removeTyping(element) {
  if (element && element.parentNode) {
    element.parentNode.removeChild(element);
  }
}

// Limpar chat
function clearChat() {
  if (confirm('Deseja limpar todo o histÃ³rico?')) {
    messagesEl.innerHTML = '';
    messageHistory = [];
    localStorage.removeItem('chatHistory');
    addMessage("Chat limpo! Como posso ajudar?", 'bot');
  }
}

// SÃ­ntese de voz
function speak(text) {
  if (!window.speechSynthesis) return;
  
  try {
    speechSynthesis.cancel();
    const cleanText = text.replace(/[ğŸ¤–ğŸ˜ŠğŸ‘‹â°ğŸ“…ğŸ˜„ğŸ§®ğŸŒ¡ï¸ğŸ“–ğŸµğŸ’¡âœ¨ğŸ‰ğŸ†âš”ï¸ğŸ˜‚ğŸŒ™ğŸ‘»ğŸ‰ğŸ’•ğŸ¤ğŸ¸ğŸ’¿ğŸºğŸ¹ğŸª•âŒâœ…]/g, '');
    const utter = new SpeechSynthesisUtterance(cleanText);
    utter.lang = 'pt-BR';
    utter.rate = 1.0;
    utter.pitch = 1.1;
    utter.volume = 0.8;
    speechSynthesis.speak(utter);
  } catch (error) {
    console.error('Erro na sÃ­ntese:', error);
  }
}

// Reconhecimento de voz
micBtn.addEventListener('click', () => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    addMessage("âš ï¸ Seu navegador nÃ£o suporta reconhecimento de voz. Use Chrome ou Edge!", 'bot');
    return;
  }
  
  const rec = new SpeechRecognition();
  rec.lang = 'pt-BR';
  rec.continuous = false;
  rec.interimResults = false;
  
  micBtn.classList.add('recording');
  micBtn.disabled = true;
  
  rec.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    input.value = transcript;
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
    handleSend();
  };
  
  rec.onerror = (error) => {
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
    console.error('Erro:', error);
    addMessage("âŒ Erro no reconhecimento. Tente novamente!", 'bot');
  };
  
  rec.onend = () => {
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
  };
  
  try {
    rec.start();
  } catch (error) {
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
    addMessage("âŒ Erro ao iniciar. Tente novamente!", 'bot');
  }
});

// Enviar mensagem rÃ¡pida
function sendQuick(text) {
  if (isProcessing) return;
  input.value = text;
  handleSend();
}

// Enviar mensagem
function handleSend() {
  const text = input.value.trim();
  if (!text || isProcessing) return;
  
  addMessage(text, 'me');
  input.value = '';
  
  isProcessing = true;
  sendBtn.disabled = true;
  
  const typingIndicator = showTyping();
  
  setTimeout(() => {
    removeTyping(typingIndicator);
    botRespond(text);
  }, 500 + Math.random() * 500);
}

sendBtn.addEventListener('click', handleSend);
input.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    handleSend();
  }
});

// Validar nome
function validateName(name) {
  name = name.trim();
  
  if (name.length < 2 || name.length > 50) {
    return null;
  }
  
  const onlyLetters = /^[a-zA-ZÃ€-Ã¿\s]+$/.test(name);
  if (!onlyLetters) {
    return null;
  }
  
  return name.split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

// Corrigir erros
function correctTypos(text) {
  const corrections = {
    'oi': ['oin', 'oii', 'oie'],
    'olÃ¡': ['ola', 'olah', 'olaa'],
    'hora': ['ora', 'hroa', 'hoora'],
    'horas': ['oras', 'horass'],
    'data': ['dta', 'dtaa', 'datta'],
    'clima': ['klima', 'climaa', 'clime'],
    'temperatura': ['temperatra', 'tempertur', 'tenperatura'],
    'tempo': ['tmepo', 'tenpo', 'tmpo'],
    'piada': ['piad', 'piadaa', 'piaada'],
    'histÃ³ria': ['istoria', 'histori', 'istÃ³ria', 'hitoria'],
    'historia': ['istoria', 'histori', 'hitoria'],
    'mÃºsica': ['musica', 'muzica', 'musicaa'],
    'calcular': ['calcula', 'cacular', 'calculr'],
    'quanto': ['qanto', 'kuanto', 'qnto']
  };
  
  let corrected = text.toLowerCase();
  
  for (let correct in corrections) {
    corrections[correct].forEach(typo => {
      const regex = new RegExp('\\b' + typo + '\\b', 'gi');
      corrected = corrected.replace(regex, correct);
    });
  }
  
  return corrected;
}

// Calcular expressÃ£o
function calcExpr(expr) {
  try {
    const original = expr;
    expr = expr.replace(/\s+/g, '');
    
    expr = expr.replace(/(\d+(?:\.\d+)?)%\s*de\s*(\d+(?:\.\d+)?)/gi, (match, percent, num) => {
      return (parseFloat(num) * parseFloat(percent) / 100).toString();
    });
    
    expr = expr.replace(/(\d+(?:\.\d+)?)%/g, (match, num) => {
      return (parseFloat(num) / 100).toString();
    });
    
    expr = expr.replace(/âˆš(\d+(?:\.\d+)?)/g, (match, num) => Math.sqrt(parseFloat(num)));
    expr = expr.replace(/(\d+(?:\.\d+)?)\^(\d+(?:\.\d+)?)/g, (match, base, exp) => Math.pow(parseFloat(base), parseFloat(exp)));
    
    expr = expr.replace(/(\d+)!/g, (match, n) => {
      let num = parseInt(n);
      if (num > 20) return 'NÃºmero muito grande!';
      if (num < 0) return 'Fatorial de negativo nÃ£o existe!';
      let result = 1;
      for (let i = 1; i <= num; i++) {
        result *= i;
      }
      return result;
    });
    
    expr = expr.replace(/log\(([^)]+)\)/g, (match, num) => Math.log10(parseFloat(num)));
    expr = expr.replace(/ln\(([^)]+)\)/g, (match, num) => Math.log(parseFloat(num)));
    
    const result = Function('"use strict"; return (' + expr + ')')();
    
    if (isNaN(result) || !isFinite(result)) {
      return null;
    }
    
    const formattedResult = Number.isInteger(result) ? result : result.toFixed(2);
    return `ğŸ§® Resultado:\n${original} = ${formattedResult}`;
  } catch (err) {
    return null;
  }
}

// Verificar se Ã© cÃ¡lculo
function isCalculation(msg) {
  const cleanMsg = msg.replace(/\s+/g, '');
  return /^[\d+\-*/().âˆš^!%]+$/.test(cleanMsg) || 
         /log\(|ln\(/.test(cleanMsg) ||
         msg.includes('calcular') ||
         msg.includes('quanto Ã©') ||
         msg.includes('quanto e') ||
         /%\s*de\s*\d+/.test(msg) ||
         /\d+%/.test(msg);
}

// Buscar clima (simulado realista)
async function getWeather(city = 'Fortaleza') {
  const climasPorCidade = {
    'fortaleza': [
      { temp: 29, feels: 32, desc: 'cÃ©u limpo', humidity: 70, wind: 22 },
      { temp: 31, feels: 34, desc: 'parcialmente nublado', humidity: 68, wind: 20 },
      { temp: 30, feels: 33, desc: 'ensolarado', humidity: 72, wind: 18 },
      { temp: 28, feels: 31, desc: 'sol com nuvens', humidity: 75, wind: 25 }
    ],
    'sao paulo': [
      { temp: 22, feels: 23, desc: 'nublado', humidity: 65, wind: 12 },
      { temp: 25, feels: 27, desc: 'parcialmente nublado', humidity: 60, wind: 10 },
      { temp: 20, feels: 21, desc: 'chuvoso', humidity: 80, wind: 15 }
    ],
    'rio de janeiro': [
      { temp: 28, feels: 30, desc: 'ensolarado', humidity: 68, wind: 18 },
      { temp: 26, feels: 28, desc: 'sol com nuvens', humidity: 72, wind: 16 },
      { temp: 30, feels: 33, desc: 'cÃ©u limpo', humidity: 65, wind: 14 }
    ],
    'default': [
      { temp: 24, feels: 26, desc: 'parcialmente nublado', humidity: 65, wind: 15 },
      { temp: 22, feels: 24, desc: 'nublado', humidity: 70, wind: 12 },
      { temp: 26, feels: 28, desc: 'ensolarado', humidity: 60, wind: 10 }
    ]
  };
  
  const cityLower = city.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const climas = climasPorCidade[cityLower] || climasPorCidade['default'];
  const clima = climas[Math.floor(Math.random() * climas.length)];
  
  return `ğŸŒ¡ï¸ Clima em ${city}:\n\nğŸŒ¡ Temperatura: ${clima.temp}Â°C\nğŸ¤’ SensaÃ§Ã£o: ${clima.feels}Â°C\nâ˜ï¸ CondiÃ§Ã£o: ${clima.desc}\nğŸ’§ Umidade: ${clima.humidity}%\nğŸ’¨ Vento: ${clima.wind} km/h\n\nğŸ’¡ Dados simulados`;
}

// Gerar histÃ³ria
function generateStory(theme, details) {
  const stories = {
    romance: `ğŸ’• ERA UMA VEZ...\n\nEm uma tarde ensolarada, ${details}. O coraÃ§Ã£o batia forte, e naquele momento mÃ¡gico, o tempo pareceu parar. Os dois sorriram, sabendo que aquele seria um momento inesquecÃ­vel. O amor estava no ar, e todos ao redor puderam sentir a energia especial daquele instante.\n\nE assim comeÃ§ou uma linda histÃ³ria de amor que seria contada por geraÃ§Ãµes! ğŸ’•âœ¨`,
    
    aventura: `ğŸ° A GRANDE AVENTURA\n\n${details}! A jornada foi cheia de desafios emocionantes e perigos inesperados. Com coragem inabalÃ¡vel e determinaÃ§Ã£o, nossos herÃ³is enfrentaram todos os obstÃ¡culos que surgiram em seu caminho.\n\nAtravessaram montanhas, cruzaram rios e enfrentaram criaturas misteriosas. No final, a vitÃ³ria foi Ã©pica e gloriosa! Uma aventura digna das maiores lendas! ğŸ†âš”ï¸`,
    
    comedia: `ğŸ˜„ QUE CONFUSÃƒO!\n\n${details}... mas tudo deu errado de um jeito absolutamente hilÃ¡rio! As coisas comeÃ§aram a acontecer de forma cada vez mais atrapalhada: tropeÃ§os engraÃ§ados, mal-entendidos cÃ´micos e situaÃ§Ãµes absurdas.\n\nCada tentativa de resolver a situaÃ§Ã£o piorava tudo de um jeito mais engraÃ§ado ainda. No final, todos caÃ­ram na risada e perceberam que Ã s vezes o melhor Ã© rir de si mesmo! ğŸ˜‚ğŸ¤£`,
    
    terror: `ğŸ‘» A NOITE DO MEDO\n\nEra uma noite escura e silenciosa quando ${details}. Um arrepio subiu pela espinha de todos os presentes. Sombras estranhas se moviam pelas paredes, e sons inexplicÃ¡veis ecoavam no ar.\n\nO coraÃ§Ã£o acelerava a cada segundo. Cada passo era uma eternidade. O medo era real e palpÃ¡vel. Seria apenas imaginaÃ§Ã£o ou havia algo realmente sinistro acontecendo? O mistÃ©rio nunca foi completamente desvendado, e atÃ© hoje ninguÃ©m sabe ao certo o que aconteceu naquela noite... ğŸ‘»ğŸŒ™`,
    
    fantasia: `ğŸ‰ MAGIA E ENCANTAMENTO\n\nNum reino distante e mÃ¡gico, ${details}. Criaturas mÃ­sticas observavam de longe, feitiÃ§os brilhantes iluminavam o cÃ©u e a magia pairava no ar como poeira de estrelas.\n\nDragÃµes majestosos voavam sobre castelos encantados, fadas danÃ§avam entre as flores luminosas e a natureza respondia aos encantamentos com cores vibrantes. Foi um espetÃ¡culo de pura magia que transformou tudo em algo verdadeiramente extraordinÃ¡rio! Uma histÃ³ria digna dos maiores contos de fadas! ğŸ‰âœ¨ğŸ”®`
  };
  
  for (let key in stories) {
    if (theme.includes(key)) {
      return stories[key];
    }
  }
  
  return `ğŸ“– UMA HISTÃ“RIA ESPECIAL\n\n${details}\n\nE assim comeÃ§a uma histÃ³ria incrÃ­vel cheia de aventuras emocionantes, personagens memorÃ¡veis e momentos inesquecÃ­veis! O que acontecerÃ¡ a seguir? SÃ³ o tempo dirÃ¡... âœ¨`;
}

// Gerar mÃºsica
function generateSong(style, theme) {
  const songs = {
    rap: `ğŸ¤ RAP DO ${theme.toUpperCase()}\n\nâ™ª Yo, yo, presta atenÃ§Ã£o,\nVou falar de ${theme} com emoÃ§Ã£o,\nNa batida pesada, flow certeiro,\nEsse sentimento Ã© verdadeiro!\n\nVem do coraÃ§Ã£o, pode acreditar,\nNa vibe do rap, sem se importar,\nCom o que vÃ£o falar, o que vÃ£o pensar,\n${theme.toUpperCase()} Ã© o que vai rolar!\n\n(RefrÃ£o)\n${theme.toUpperCase()}, isso Ã© real,\nNa vibe do rap, sensacional,\n${theme.toUpperCase()}, sem igual,\nEssa rima Ã© phenomenal! â™ª\n\nğŸ¤ (Drop pesado!)`,
    
    rock: `ğŸ¸ ROCK DE ${theme.toUpperCase()}\n\nâ™ª Yeah! Yeah! Yeah!\n${theme} no coraÃ§Ã£o,\nGuitarra gritando com paixÃ£o,\nBateria explodindo sem parar,\nBaixo pulsando pra arrasar!\n\nNessa energia nÃ£o dÃ¡ pra segurar,\nO palco inteiro vai balanÃ§ar,\nErga os braÃ§os, vem gritar,\nEsse rock vai te conquistar!\n\n(RefrÃ£o)\n${theme.toUpperCase()}! Sinta o poder,\nRock'n'roll atÃ© amanhecer,\n${theme.toUpperCase()}! Vem com a gente,\nEssa banda Ã© diferente! â™ª\n\nğŸ¸ (Solo Ã©pico de guitarra!)`,
    
    pop: `ğŸ’¿ POP ${theme.toUpperCase()}\n\nâ™ª La la la, la la la,\n${theme} me faz voar,\nMelodia chiclete grudando,\nImpossÃ­vel nÃ£o danÃ§ar!\n\nBrilha como estrela no cÃ©u,\nCores vibrantes como arco-Ã­ris,\nEssa vibe contagiante,\nTodo mundo Ã© feliz!\n\n(RefrÃ£o)\n${theme.toUpperCase()}, vocÃª e eu,\nNessa vibe que aconteceu,\n${theme.toUpperCase()}, pura alegria,\nPop que contagia todo dia! â™ª\n\nğŸ’¿ (Beat danÃ§ante!)`,
    
    samba: `ğŸº SAMBA DO ${theme.toUpperCase()}\n\nâ™ª Ã” laiÃ¡, Ã´ laiÃ¡,\n${theme} no samba a balanÃ§ar,\nPandeiro batendo com maestria,\nCavaquinho tocando harmonia!\n\nTamborim fazendo o repique,\nSurdo marcando o compasso chique,\nNo balanÃ§o brasileiro raiz,\nEsse samba deixa todo mundo feliz!\n\n(RefrÃ£o)\n${theme.toUpperCase()} no pÃ©,\nSamba que tem axÃ©,\n${theme.toUpperCase()} a gingar,\nVem com a gente sambar! â™ª\n\nğŸº (Swing brasileiro autÃªntico!)`,
    
    funk: `ğŸ¹ FUNK DO ${theme.toUpperCase()}\n\nâ™ª TÃ¡ tÃ¡ tÃ¡ tum tum,\n${theme} no funk, nenhum,\nGrave batendo forte na caixa,\nA pista toda se abaixa!\n\nSobe desce no movimento,\nSentindo o grave no momento,\nBatidÃ£o que nÃ£o tem fim,\nEssa vibe tÃ¡ on assim!\n\n(RefrÃ£o)\n${theme.toUpperCase()}, desce, sobe,\nO grave explode,\n${theme.toUpperCase()}, tÃ¡ bombando,\nO funkeiro tÃ¡ mandando! â™ª\n\nğŸ¹ (BatidÃ£o de MTG!)`,
    
    sertanejo: `ğŸª• SERTANEJO ${theme.toUpperCase()}\n\nâ™ª Ai ai ai, coraÃ§Ã£o,\n${theme} nessa canÃ§Ã£o,\nViolÃ£o tocando suavemente,\nSentimento que a gente sente!\n\nNa modÃ£o que emociona,\nVoz que ressoa e apaixona,\nEsse som raiz de verdade,\nTraz saudade e felicidade!\n\n(RefrÃ£o)\n${theme.toUpperCase()}, amor demais,\nSertanejo que a gente faz,\n${theme.toUpperCase()}, sem igual,\nMÃ³dÃ£o sensacional! â™ª\n\nğŸª• (Viola caipira raiz!)`,
    
    classica: `ğŸ» CLÃSSICA ${theme.toUpperCase()}\n\nâ™ª Em majestosas notas que ecoam,\n${theme} em melodias que soam,\nViolinos danÃ§ando com graÃ§a,\nPiano tecendo uma trama que passa.\n\nOrquestra completa em harmonia,\nCrescendo que traz poesia,\nMovimento sublime e profundo,\nEmocionando todo o mundo!\n\n(Final)\n${theme.toUpperCase()} em sinfonia,\nArte pura, melodia,\nÃ“pera que transcende,\nMÃºsica que compreende! â™ª\n\nğŸ» (Finale grandioso!)`
  };
  
  for (let key in songs) {
    if (style.includes(key)) {
      return songs[key];
    }
  }
  
  return `ğŸµ MÃšSICA SOBRE ${theme.toUpperCase()}\n\nâ™ª Uma melodia linda e envolvente,\nSobre ${theme} tÃ£o presente,\nNotas que tocam no coraÃ§Ã£o,\nRitmo cheio de emoÃ§Ã£o!\n\nCada acorde uma surpresa,\nCada verso com destreza,\nEssa mÃºsica especial,\nÃ‰ simplesmente sensacional! â™ª`;
}

// Responder ao usuÃ¡rio
async function botRespond(msg) {
  try {
    let response = '';
    const msgLower = correctTypos(msg.toLowerCase().trim());
    
    // MÃ¡quina de estados
    switch (conversationState) {
      case 'WAITING_NAME':
        const validName = validateName(msg);
        if (!validName) {
          response = "âŒ Por favor, digite apenas letras no seu nome, sem nÃºmeros ou caracteres especiais! Tente novamente: ğŸ˜Š";
        } else {
          userName = validName;
          localStorage.setItem('userName', userName);
          conversationState = 'IDLE';
          response = `Muito prazer, ${userName}! ğŸ‰\n\nEstou aqui para ajudar com:\nâ€¢ CÃ¡lculos matemÃ¡ticos ğŸ§®\nâ€¢ InformaÃ§Ãµes de clima ğŸŒ¡ï¸\nâ€¢ HistÃ³rias criativas ğŸ“–\nâ€¢ MÃºsicas originais ğŸµ\nâ€¢ E muito mais!\n\nComo posso ajudar vocÃª hoje?`;
        }
        break;
        
      case 'WAITING_STORY_THEME':
        tempData.storyTheme = msgLower;
        conversationState = 'WAITING_STORY_DETAILS';
        response = "âœ¨ Excelente escolha!\n\nAgora me conte os detalhes:\n\nQuem sÃ£o os personagens e o que acontece na histÃ³ria?\n\nExemplo:\nâ€¢ 'JoÃ£o encontra Maria na praia'\nâ€¢ 'Pedro salva Ana do dragÃ£o'\nâ€¢ 'Luna descobre um portal mÃ¡gico'\n\nSeja criativo! ğŸ¨";
        break;
        
      case 'WAITING_STORY_DETAILS':
        response = generateStory(tempData.storyTheme, msg);
        conversationState = 'IDLE';
        tempData = {};
        break;
        
      case 'WAITING_SONG_STYLE':
        tempData.songStyle = msgLower;
        conversationState = 'WAITING_SONG_THEME';
        response = "ğŸ¶ Estilo escolhido!\n\nAgora me diga: sobre o que vai ser a mÃºsica?\n\nExemplos:\nâ€¢ Amor ğŸ’•\nâ€¢ Amizade ğŸ¤\nâ€¢ Festa ğŸ‰\nâ€¢ SuperaÃ§Ã£o ğŸ’ª\nâ€¢ Saudade ğŸ˜¢\nâ€¢ Alegria ğŸ˜„\n\nQual o tema? âœ¨";
        break;
        
      case 'WAITING_SONG_THEME':
        response = generateSong(tempData.songStyle, msg);
        conversationState = 'IDLE';
        tempData = {};
        break;
        
      default:
        // Verificar cÃ¡lculo
        if (isCalculation(msg)) {
          const calcResult = calcExpr(msg);
          if (calcResult) {
            response = calcResult;
          }
        }
        
        // Comandos normais
        if (!response) {
          if (msgLower.includes("temperatura") || msgLower.includes("clima") || msgLower.includes("tempo")) {
            let city = 'Fortaleza';
            const cityMatch = msg.match(/em\s+([a-zA-ZÃ€-Ã¿\s]+)|de\s+([a-zA-ZÃ€-Ã¿\s]+)/i);
            if (cityMatch) {
              city = (cityMatch[1] || cityMatch[2]).trim();
            }
            response = await getWeather(city);
          }
          else if (msgLower.includes('histÃ³ria') || msgLower.includes('historia') || msgLower.includes('conto')) {
            conversationState = 'WAITING_STORY_THEME';
            response = "ğŸ“– Vou criar uma histÃ³ria incrÃ­vel para vocÃª!\n\nEscolha um tema:\n\nğŸ’• Romance - HistÃ³rias de amor\nğŸ° Aventura - AÃ§Ã£o e perigo\nğŸ˜„ ComÃ©dia - Muita risada\nğŸ‘» Terror - Suspense arrepiante\nğŸ‰ Fantasia - Magia e encantamento\n\nDigite o tema escolhido!";
          }
          else if (msgLower.includes('mÃºsica') || msgLower.includes('musica') || msgLower.includes('canÃ§Ã£o')) {
            conversationState = 'WAITING_SONG_STYLE';
            response = "ğŸµ Vou criar uma mÃºsica especial!\n\nQue estilo musical vocÃª prefere?\n\nğŸ¤ Rap - Flow e rima\nğŸ¸ Rock - Energia total\nğŸ’¿ Pop - Melodia chiclete\nğŸº Samba - Swing brasileiro\nğŸ¹ Funk - BatidÃ£o pesado\nğŸª• Sertanejo - ModÃ£o raiz\nğŸ» ClÃ¡ssica - Orquestra\n\nDigite o estilo!";
          }
          else if (msgLower.includes('oi') || msgLower.includes('olÃ¡') || msgLower.includes('ola') || msgLower.includes('hey') || msgLower.includes('eai')) {
            if (userName) {
              const saudacoes = [
                `Oi, ${userName}! ğŸ‘‹ Como vai vocÃª?`,
                `OlÃ¡, ${userName}! ğŸ˜Š Tudo bem?`,
                `E aÃ­, ${userName}! ğŸ‰ Pronto para uma conversa?`,
                `Fala, ${userName}! ğŸš€ No que posso ajudar?`
              ];
              response = saudacoes[Math.floor(Math.random() * saudacoes.length)];
            } else {
              response = "OlÃ¡! ğŸ‘‹ Seja muito bem-vindo!\n\nEu sou seu assistente virtual e posso ajudar com muitas coisas!\n\nPara comeÃ§ar, qual Ã© o seu nome? ğŸ˜Š";
              conversationState = 'WAITING_NAME';
            }
          }
          else if (msgLower.includes('hora') || msgLower.includes('horas')) {
            const now = new Date();
            const hora = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            response = `â° Agora sÃ£o exatamente ${hora}`;
          }
          else if (msgLower.includes('data') || msgLower.includes('dia')) {
            const now = new Date();
            const data = now.toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'});
            response = `ğŸ“… Hoje Ã© ${data}`;
          }
          else if (msgLower.includes('piada') || msgLower.includes('graÃ§a') || msgLower.includes('engraÃ§ado')) {
            const piadas = [
              "ğŸ˜‚ Por que o livro de matemÃ¡tica ficou triste?\nPorque ele tinha muitos problemas!",
              "ğŸ˜„ Por que o computador foi ao mÃ©dico?\nPorque estava com vÃ­rus!",
              "ğŸ¤£ O que o zero disse para o oito?\nQue cinto maneiro!",
              "ğŸ˜† Por que a galinha atravessou a estrada?\nPara chegar do outro lado!",
              "ğŸ˜‚ Qual Ã© o contrÃ¡rio de volÃ¡til?\nVem cÃ¡ sobrinho!",
              "ğŸ¤£ Por que o Ã¡tomo foi preso?\nPorque ele agrediu com Ã­ons!",
              "ğŸ˜„ O que o pato disse para a pata?\nVem quÃ¡!",
              "ğŸ˜† Por que o elefante nÃ£o usa computador?\nPorque tem medo do mouse!"
            ];
            response = piadas[Math.floor(Math.random() * piadas.length)];
          }
          else if (msgLower.includes('obrigad') || msgLower.includes('valeu') || msgLower.includes('vlw')) {
            const respostas = [
              "ğŸ˜Š Por nada! Estou sempre aqui para ajudar!",
              "ğŸ‰ Disponha! Ã‰ um prazer ajudar vocÃª!",
              "ğŸ’™ Que isso! Conte comigo sempre!",
              "âœ¨ Fico feliz em poder ajudar!"
            ];
            response = respostas[Math.floor(Math.random() * respostas.length)];
          }
          else if (msgLower.includes('tchau') || msgLower.includes('atÃ©') || msgLower.includes('adeus') || msgLower.includes('flw')) {
            const despedidas = [
              "ğŸ‘‹ AtÃ© logo! Volte sempre que precisar!",
              "ğŸ˜Š Tchau! Foi Ã³timo conversar com vocÃª!",
              "ğŸ‰ AtÃ© a prÃ³xima! Estarei aqui quando precisar!",
              "ğŸ’™ AtÃ© breve! Cuide-se!"
            ];
            response = despedidas[Math.floor(Math.random() * despedidas.length)];
          }
          else if (msgLower.includes('quem criou') || msgLower.includes('quem fez') || msgLower.includes('sobre vocÃª') || msgLower.includes('quem Ã© vocÃª')) {
            response = "ğŸ¤– Sobre Mim:\n\nSou um assistente virtual desenvolvido pelo aluno JoÃ£o Gabriel Marinho! ğŸ‘¨â€ğŸ’»\n\nFui criado com tecnologias web modernas (HTML, CSS e JavaScript) e tenho vÃ¡rias funcionalidades incrÃ­veis:\n\nâœ¨ Reconhecimento e sÃ­ntese de voz\nğŸ§® Calculadora avanÃ§ada\nğŸ“– Gerador de histÃ³rias criativas\nğŸµ Compositor de mÃºsicas\nğŸŒ¡ï¸ Consulta de clima\nğŸ’¾ MemÃ³ria de conversas\n\nğŸ‘¤ Criador: JoÃ£o Gabriel Marinho\nğŸ’» Tecnologias: HTML5, CSS3, JavaScript\n\nEstou aqui para ajudar, aprender e tornar sua experiÃªncia mais divertida! ğŸš€";
          }
          else if (msgLower.includes('ajuda') || msgLower.includes('help') || msgLower.includes('comandos') || msgLower.includes('o que vocÃª faz')) {
            response = "ğŸ¯ Como posso ajudar:\n\nğŸ§® CÃLCULOS:\nâ€¢ Digite operaÃ§Ãµes: 50+50, 10*5\nâ€¢ Porcentagens: 20% de 100\nâ€¢ AvanÃ§ado: âˆš25, 2^3, 5!\n\nğŸŒ¡ï¸ CLIMA:\nâ€¢ 'Qual a temperatura?'\nâ€¢ 'Clima em SÃ£o Paulo'\n\nğŸ“– HISTÃ“RIAS:\nâ€¢ 'Conte uma histÃ³ria'\nâ€¢ Escolha tema e personagens\n\nğŸµ MÃšSICAS:\nâ€¢ 'Crie uma mÃºsica'\nâ€¢ Escolha estilo e tema\n\nâ° UTILITÃRIOS:\nâ€¢ Hora atual\nâ€¢ Data de hoje\nâ€¢ Piadas\n\nExperimente! ğŸ˜Š";
          }
          else if (!userName) {
            conversationState = 'WAITING_NAME';
            response = "ğŸ˜Š OlÃ¡! Para comeÃ§armos, qual Ã© o seu nome?\n\n(Digite apenas letras, por favor!)";
          }
          else {
            const respostas = [
              `ğŸ¤” Hmm, nÃ£o entendi muito bem, ${userName}.\n\nTente perguntar sobre:\nâ€¢ Hora ou data\nâ€¢ Clima\nâ€¢ CÃ¡lculos matemÃ¡ticos\nâ€¢ HistÃ³rias criativas\nâ€¢ MÃºsicas originais\nâ€¢ Ou digite 'ajuda' para ver todos os comandos!`,
              `Desculpe, ${userName}, ainda estou aprendendo! ğŸ“\n\nPosso ajudar com cÃ¡lculos, clima, histÃ³rias, mÃºsicas e muito mais!\n\nQue tal tentar um dos botÃµes acima? ğŸ˜Š`,
              `NÃ£o entendi essa, ${userName}! ğŸ˜…\n\nDigite 'ajuda' para ver tudo que eu posso fazer!`
            ];
            response = respostas[Math.floor(Math.random() * respostas.length)];
          }
        }
    }
    
    addMessage(response, 'bot');
  } catch (error) {
    console.error('Erro no bot:', error);
    addMessage("ğŸ˜” Ops! Algo deu errado. Tente novamente!", 'bot');
  } finally {
    isProcessing = false;
    sendBtn.disabled = false;
  }
}
</script>
</body>
</html>
