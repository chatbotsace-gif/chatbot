<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistente Virtual</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
  background-size: 200% 200%;
  animation: gradientShift 15s ease infinite;
  color: #e2e8f0;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.header {
  padding: 16px 20px;
  background: linear-gradient(135deg, #1e40af, #3b82f6, #2563eb);
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.logo {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #60a5fa, #3b82f6);
  font-size: 22px;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
  animation: float 3s ease-in-out infinite;
  z-index: 1;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-5px); }
}

.header-title {
  flex: 1;
  z-index: 1;
}

.header-title h1 {
  font-size: 20px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.header-title p {
  font-size: 13px;
  opacity: 0.9;
  margin-top: 2px;
}

.status {
  font-size: 12px;
  padding: 6px 12px;
  border-radius: 20px;
  background: rgba(16, 185, 129, 0.25);
  border: 1px solid rgba(16, 185, 129, 0.4);
  z-index: 1;
  backdrop-filter: blur(10px);
}

.status-dot {
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
  display: inline-block;
  margin-right: 6px;
  animation: pulse 2s infinite;
  box-shadow: 0 0 8px #10b981;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.2); }
}

.quickActions {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 12px;
  background: rgba(15, 23, 42, 0.95);
  scrollbar-width: thin;
  border-bottom: 1px solid rgba(59, 130, 246, 0.2);
}

.quickActions::-webkit-scrollbar {
  height: 6px;
}

.quickActions::-webkit-scrollbar-thumb {
  background: rgba(59, 130, 246, 0.5);
  border-radius: 3px;
}

.quickActions button {
  padding: 10px 16px;
  border: none;
  border-radius: 20px;
  background: rgba(37, 99, 235, 0.25);
  color: #93c5fd;
  font-size: 13px;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.quickActions button:hover {
  background: rgba(59, 130, 246, 0.4);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.quickActions button:active {
  transform: translateY(0px);
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 16px 90px 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  scroll-behavior: smooth;
}

.messages::-webkit-scrollbar {
  width: 8px;
}

.messages::-webkit-scrollbar-track {
  background: rgba(15, 23, 42, 0.5);
}

.messages::-webkit-scrollbar-thumb {
  background: rgba(59, 130, 246, 0.5);
  border-radius: 4px;
}

.msg-wrapper {
  display: flex;
  gap: 12px;
  animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.msg-wrapper.me {
  flex-direction: row-reverse;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.avatar.user {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
}

.avatar.bot {
  background: linear-gradient(135deg, #06b6d4, #0891b2);
}

.msg {
  padding: 12px 16px;
  border-radius: 18px;
  max-width: 75%;
  font-size: 14px;
  line-height: 1.6;
  word-wrap: break-word;
  white-space: pre-line;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.msg-wrapper.me .msg {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  color: #fff;
  border-bottom-right-radius: 4px;
}

.msg-wrapper.bot .msg {
  background: rgba(30, 41, 59, 0.9);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-bottom-left-radius: 4px;
  backdrop-filter: blur(10px);
}

.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #3b82f6;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.7;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}

.inputArea {
  display: flex;
  padding: 12px;
  gap: 10px;
  background: rgba(15, 23, 42, 0.98);
  border-top: 1px solid rgba(59, 130, 246, 0.3);
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  backdrop-filter: blur(15px);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
}

.inputArea input {
  flex: 1;
  padding: 14px 18px;
  border-radius: 24px;
  border: 2px solid rgba(59, 130, 246, 0.4);
  background: rgba(30, 41, 59, 0.7);
  color: #e2e8f0;
  font-size: 14px;
  outline: none;
  transition: all 0.3s;
}

.inputArea input:focus {
  border-color: rgba(59, 130, 246, 0.8);
  background: rgba(30, 41, 59, 0.9);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.inputArea button {
  padding: 14px 20px;
  border: none;
  border-radius: 24px;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.inputArea button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
}

.inputArea button:active:not(:disabled) {
  transform: translateY(0px);
}

.inputArea button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#micBtn {
  background: linear-gradient(135deg, #10b981, #059669);
  min-width: 50px;
  font-size: 16px;
}

#micBtn.recording {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  animation: recordPulse 1s infinite;
}

@keyframes recordPulse {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
  }
  50% {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.8);
  }
}

.clear-btn {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  transition: all 0.3s;
  z-index: 10;
}

.clear-btn:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
}

@media (max-width: 600px) {
  .msg {
    max-width: 85%;
  }
  
  .header-title h1 {
    font-size: 16px;
  }
  
  .header-title p {
    font-size: 11px;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="logo">ü§ñ</div>
  <div class="header-title">
    <h1>Assistente Virtual Pro</h1>
    <p>Inteligente, r√°pido e divertido!</p>
  </div>
  <div class="status"><span class="status-dot"></span>Online</div>
</div>

<div class="quickActions">
  <button onclick="sendQuick('Oi')">üëã Saudar</button>
  <button onclick="sendQuick('Que horas s√£o?')">‚è∞ Hora</button>
  <button onclick="sendQuick('Qual a data?')">üìÖ Data</button>
  <button onclick="sendQuick('Me conte uma piada')">üòÑ Piada</button>
  <button onclick="sendQuick('50% de 200')">üßÆ Calcular</button>
  <button onclick="sendQuick('Qual a temperatura?')">üå°Ô∏è Clima</button>
  <button onclick="sendQuick('Conte uma hist√≥ria')">üìñ Hist√≥ria</button>
  <button onclick="sendQuick('Crie uma m√∫sica')">üéµ M√∫sica</button>
  <button onclick="sendQuick('Quem criou voc√™?')">‚ÑπÔ∏è Sobre</button>
</div>

<div id="messages" class="messages"></div>

<button class="clear-btn" onclick="clearChat()" title="Limpar chat">üóëÔ∏è</button>

<div class="inputArea">
  <input id="inputMsg" placeholder="Digite sua mensagem..." autocomplete="off">
  <button id="micBtn">üé§</button>
  <button id="sendBtn">Enviar</button>
</div>

<script>
const messagesEl = document.getElementById('messages');
const input = document.getElementById('inputMsg');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');

const OPENWEATHER_API_KEY = '2cf489c19d902e5035391aa67d9ef883';

let userName = null;
let isProcessing = false;
let conversationState = 'IDLE';
let tempData = {};
let messageHistory = [];

// Carregar dados salvos
window.addEventListener('DOMContentLoaded', () => {
  const savedName = localStorage.getItem('userName');
  if (savedName) {
    userName = savedName;
  }
  
  const savedHistory = localStorage.getItem('chatHistory');
  if (savedHistory) {
    try {
      const history = JSON.parse(savedHistory);
      history.forEach(msg => {
        addMessage(msg.text, msg.who, false);
      });
    } catch (e) {
      console.error('Erro ao carregar hist√≥rico');
    }
  }
  
  if (messagesEl.children.length === 0) {
    addMessage("Ol√°! üëã Sou seu assistente virtual. Como posso ajudar?", 'bot', false);
  }
});

// Adicionar mensagem
function addMessage(text, who = 'bot', shouldSave = true) {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrapper ' + who;
  
  const avatar = document.createElement('div');
  avatar.className = 'avatar ' + (who === 'me' ? 'user' : 'bot');
  avatar.textContent = who === 'me' ? 'üë§' : 'ü§ñ';
  
  const msg = document.createElement('div');
  msg.className = 'msg';
  msg.textContent = text;
  
  wrap.appendChild(avatar);
  wrap.appendChild(msg);
  messagesEl.appendChild(wrap);
  
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  if (shouldSave) {
    messageHistory.push({ text, who });
    if (messageHistory.length > 50) {
      messageHistory.shift();
    }
    localStorage.setItem('chatHistory', JSON.stringify(messageHistory));
  }
  
  if (who === 'bot') {
    speak(text);
  }
}

// Indicador de digita√ß√£o
function showTyping() {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrapper bot typing-wrapper';
  wrap.innerHTML = `
    <div class="avatar bot">ü§ñ</div>
    <div class="msg">
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  `;
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return wrap;
}

function removeTyping(element) {
  if (element && element.parentNode) {
    element.parentNode.removeChild(element);
  }
}

// Limpar chat
function clearChat() {
  if (confirm('Deseja limpar todo o hist√≥rico?')) {
    messagesEl.innerHTML = '';
    messageHistory = [];
    localStorage.removeItem('chatHistory');
    addMessage("Chat limpo! Como posso ajudar?", 'bot');
  }
}

// S√≠ntese de voz
function speak(text) {
  if (!window.speechSynthesis) return;
  
  try {
    speechSynthesis.cancel();
    const cleanText = text.replace(/[ü§ñüòäüëã‚è∞üìÖüòÑüßÆüå°Ô∏èüìñüéµüí°‚ú®üéâüèÜ‚öîÔ∏èüòÇüåôüëªüêâüíïüé§üé∏üíøüé∫üéπü™ï‚ùå‚úÖ]/g, '');
    const utter = new SpeechSynthesisUtterance(cleanText);
    utter.lang = 'pt-BR';
    utter.rate = 1.0;
    utter.pitch = 1.1;
    utter.volume = 0.8;
    speechSynthesis.speak(utter);
  } catch (error) {
    console.error('Erro na s√≠ntese:', error);
  }
}

// Reconhecimento de voz
micBtn.addEventListener('click', () => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    addMessage("‚ö†Ô∏è Seu navegador n√£o suporta reconhecimento de voz. Use Chrome ou Edge!", 'bot');
    return;
  }
  
  const rec = new SpeechRecognition();
  rec.lang = 'pt-BR';
  rec.continuous = false;
  rec.interimResults = false;
  
  micBtn.classList.add('recording');
  micBtn.disabled = true;
  
  rec.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    input.value = transcript;
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
    handleSend();
  };
  
  rec.onerror = (error) => {
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
    console.error('Erro:', error);
    addMessage("‚ùå Erro no reconhecimento. Tente novamente!", 'bot');
  };
  
  rec.onend = () => {
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
  };
  
  try {
    rec.start();
  } catch (error) {
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
    addMessage("‚ùå Erro ao iniciar. Tente novamente!", 'bot');
  }
});

// Enviar mensagem r√°pida
function sendQuick(text) {
  if (isProcessing) return;
  input.value = text;
  handleSend();
}

// Enviar mensagem
function handleSend() {
  const text = input.value.trim();
  if (!text || isProcessing) return;
  
  addMessage(text, 'me');
  input.value = '';
  
  isProcessing = true;
  sendBtn.disabled = true;
  
  const typingIndicator = showTyping();
  
  setTimeout(() => {
    removeTyping(typingIndicator);
    botRespond(text);
  }, 500 + Math.random() * 500);
}

sendBtn.addEventListener('click', handleSend);
input.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    handleSend();
  }
});

// Validar nome
function validateName(name) {
  name = name.trim();
  
  if (name.length < 2 || name.length > 50) {
    return null;
  }
  
  const onlyLetters = /^[a-zA-Z√Ä-√ø\s]+$/.test(name);
  if (!onlyLetters) {
    return null;
  }
  
  return name.split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

// Corrigir erros
function correctTypos(text) {
  const corrections = {
    'oi': ['oin', 'oii', 'oie'],
    'ol√°': ['ola', 'olah', 'olaa'],
    'hora': ['ora', 'hroa', 'hoora'],
    'horas': ['oras', 'horass'],
    'data': ['dta', 'dtaa', 'datta'],
    'clima': ['klima', 'climaa', 'clime'],
    'temperatura': ['temperatra', 'tempertur', 'tenperatura'],
    'tempo': ['tmepo', 'tenpo', 'tmpo'],
    'piada': ['piad', 'piadaa', 'piaada'],
    'hist√≥ria': ['istoria', 'histori', 'ist√≥ria', 'hitoria'],
    'historia': ['istoria', 'histori', 'hitoria'],
    'm√∫sica': ['musica', 'muzica', 'musicaa'],
    'calcular': ['calcula', 'cacular', 'calculr'],
    'quanto': ['qanto', 'kuanto', 'qnto']
  };
  
  let corrected = text.toLowerCase();
  
  for (let correct in corrections) {
    corrections[correct].forEach(typo => {
      const regex = new RegExp('\\b' + typo + '\\b', 'gi');
      corrected = corrected.replace(regex, correct);
    });
  }
  
  return corrected;
}

// Calcular express√£o
function calcExpr(expr) {
  try {
    const original = expr;
    expr = expr.replace(/\s+/g, '');
    
    expr = expr.replace(/(\d+(?:\.\d+)?)%\s*de\s*(\d+(?:\.\d+)?)/gi, (match, percent, num) => {
      return (parseFloat(num) * parseFloat(percent) / 100).toString();
    });
    
    expr = expr.replace(/(\d+(?:\.\d+)?)%/g, (match, num) => {
      return (parseFloat(num) / 100).toString();
    });
    
    expr = expr.replace(/‚àö(\d+(?:\.\d+)?)/g, (match, num) => Math.sqrt(parseFloat(num)));
    expr = expr.replace(/(\d+(?:\.\d+)?)\^(\d+(?:\.\d+)?)/g, (match, base, exp) => Math.pow(parseFloat(base), parseFloat(exp)));
    
    expr = expr.replace(/(\d+)!/g, (match, n) => {
      let num = parseInt(n);
      if (num > 20) return 'N√∫mero muito grande!';
      if (num < 0) return 'Fatorial de negativo n√£o existe!';
      let result = 1;
      for (let i = 1; i <= num; i++) {
        result *= i;
      }
      return result;
    });
    
    expr = expr.replace(/log\(([^)]+)\)/g, (match, num) => Math.log10(parseFloat(num)));
    expr = expr.replace(/ln\(([^)]+)\)/g, (match, num) => Math.log(parseFloat(num)));
    
    const result = Function('"use strict"; return (' + expr + ')')();
    
    if (isNaN(result) || !isFinite(result)) {
      return null;
    }
    
    const formattedResult = Number.isInteger(result) ? result : result.toFixed(2);
    return `üßÆ Resultado:\n${original} = ${formattedResult}`;
  } catch (err) {
    return null;
  }
}

// Verificar se √© c√°lculo
function isCalculation(msg) {
  const cleanMsg = msg.replace(/\s+/g, '');
  return /^[\d+\-*/().‚àö^!%]+$/.test(cleanMsg) || 
         /log\(|ln\(/.test(cleanMsg) ||
         msg.includes('calcular') ||
         msg.includes('quanto √©') ||
         msg.includes('quanto e') ||
         /%\s*de\s*\d+/.test(msg) ||
         /\d+%/.test(msg);
}

// Buscar clima (simulado realista)
async function getWeather(city = 'Fortaleza') {
  const climasPorCidade = {
    'fortaleza': [
      { temp: 29, feels: 32, desc: 'c√©u limpo', humidity: 70, wind: 22 },
      { temp: 31, feels: 34, desc: 'parcialmente nublado', humidity: 68, wind: 20 },
      { temp: 30, feels: 33, desc: 'ensolarado', humidity: 72, wind: 18 },
      { temp: 28, feels: 31, desc: 'sol com nuvens', humidity: 75, wind: 25 }
    ],
    'sao paulo': [
      { temp: 22, feels: 23, desc: 'nublado', humidity: 65, wind: 12 },
      { temp: 25, feels: 27, desc: 'parcialmente nublado', humidity: 60, wind: 10 },
      { temp: 20, feels: 21, desc: 'chuvoso', humidity: 80, wind: 15 }
    ],
    'rio de janeiro': [
      { temp: 28, feels: 30, desc: 'ensolarado', humidity: 68, wind: 18 },
      { temp: 26, feels: 28, desc: 'sol com nuvens', humidity: 72, wind: 16 },
      { temp: 30, feels: 33, desc: 'c√©u limpo', humidity: 65, wind: 14 }
    ],
    'default': [
      { temp: 24, feels: 26, desc: 'parcialmente nublado', humidity: 65, wind: 15 },
      { temp: 22, feels: 24, desc: 'nublado', humidity: 70, wind: 12 },
      { temp: 26, feels: 28, desc: 'ensolarado', humidity: 60, wind: 10 }
    ]
  };
  
  const cityLower = city.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const climas = climasPorCidade[cityLower] || climasPorCidade['default'];
  const clima = climas[Math.floor(Math.random() * climas.length)];
  
  return `üå°Ô∏è Clima em ${city}:\n\nüå° Temperatura: ${clima.temp}¬∞C\nü§í Sensa√ß√£o: ${clima.feels}¬∞C\n‚òÅÔ∏è Condi√ß√£o: ${clima.desc}\nüíß Umidade: ${clima.humidity}%\nüí® Vento: ${clima.wind} km/h\n\nüí° Dados simulados`;
}

// Gerar hist√≥ria
function generateStory(theme, details) {
  const stories = {
    romance: `üíï ERA UMA VEZ...\n\nEm uma tarde ensolarada, ${details}. O cora√ß√£o batia forte, e naquele momento m√°gico, o tempo pareceu parar. Os dois sorriram, sabendo que aquele seria um momento inesquec√≠vel. O amor estava no ar, e todos ao redor puderam sentir a energia especial daquele instante.\n\nE assim come√ßou uma linda hist√≥ria de amor que seria contada por gera√ß√µes! üíï‚ú®`,
    
    aventura: `üè∞ A GRANDE AVENTURA\n\n${details}! A jornada foi cheia de desafios emocionantes e perigos inesperados. Com coragem inabal√°vel e determina√ß√£o, nossos her√≥is enfrentaram todos os obst√°culos que surgiram em seu caminho.\n\nAtravessaram montanhas, cruzaram rios e enfrentaram criaturas misteriosas. No final, a vit√≥ria foi √©pica e gloriosa! Uma aventura digna das maiores lendas! üèÜ‚öîÔ∏è`,
    
    comedia: `üòÑ QUE CONFUS√ÉO!\n\n${details}... mas tudo deu errado de um jeito absolutamente hil√°rio! As coisas come√ßaram a acontecer de forma cada vez mais atrapalhada: trope√ßos engra√ßados, mal-entendidos c√¥micos e situa√ß√µes absurdas.\n\nCada tentativa de resolver a situa√ß√£o piorava tudo de um jeito mais engra√ßado ainda. No final, todos ca√≠ram na risada e perceberam que √†s vezes o melhor √© rir de si mesmo! üòÇü§£`,
    
    terror: `üëª A NOITE DO MEDO\n\nEra uma noite escura e silenciosa quando ${details}. Um arrepio subiu pela espinha de todos os presentes. Sombras estranhas se moviam pelas paredes, e sons inexplic√°veis ecoavam no ar.\n\nO cora√ß√£o acelerava a cada segundo. Cada passo era uma eternidade. O medo era real e palp√°vel. Seria apenas imagina√ß√£o ou havia algo realmente sinistro acontecendo? O mist√©rio nunca foi completamente desvendado, e at√© hoje ningu√©m sabe ao certo o que aconteceu naquela noite... üëªüåô`,
    
    fantasia: `üêâ MAGIA E ENCANTAMENTO\n\nNum reino distante e m√°gico, ${details}. Criaturas m√≠sticas observavam de longe, feiti√ßos brilhantes iluminavam o c√©u e a magia pairava no ar como poeira de estrelas.\n\nDrag√µes majestosos voavam sobre castelos encantados, fadas dan√ßavam entre as flores luminosas e a natureza respondia aos encantamentos com cores vibrantes. Foi um espet√°culo de pura magia que transformou tudo em algo verdadeiramente extraordin√°rio! Uma hist√≥ria digna dos maiores contos de fadas! üêâ‚ú®üîÆ`
  };
  
  for (let key in stories) {
    if (theme.includes(key)) {
      return stories[key];
    }
  }
  
  return `üìñ UMA HIST√ìRIA ESPECIAL\n\n${details}\n\nE assim come√ßa uma hist√≥ria incr√≠vel cheia de aventuras emocionantes, personagens memor√°veis e momentos inesquec√≠veis! O que acontecer√° a seguir? S√≥ o tempo dir√°... ‚ú®`;
}

// Gerar m√∫sica
function generateSong(style, theme) {
  const songs = {
    rap: `üé§ RAP DO ${theme.toUpperCase()}\n\n‚ô™ Yo, yo, presta aten√ß√£o,\nVou falar de ${theme} com emo√ß√£o,\nNa batida pesada, flow certeiro,\nEsse sentimento √© verdadeiro!\n\nVem do cora√ß√£o, pode acreditar,\nNa vibe do rap, sem se importar,\nCom o que v√£o falar, o que v√£o pensar,\n${theme.toUpperCase()} √© o que vai rolar!\n\n(Refr√£o)\n${theme.toUpperCase()}, isso √© real,\nNa vibe do rap, sensacional,\n${theme.toUpperCase()}, sem igual,\nEssa rima √© phenomenal! ‚ô™\n\nüé§ (Drop pesado!)`,
    
    rock: `üé∏ ROCK DE ${theme.toUpperCase()}\n\n‚ô™ Yeah! Yeah! Yeah!\n${theme} no cora√ß√£o,\nGuitarra gritando com paix√£o,\nBateria explodindo sem parar,\nBaixo pulsando pra arrasar!\n\nNessa energia n√£o d√° pra segurar,\nO palco inteiro vai balan√ßar,\nErga os bra√ßos, vem gritar,\nEsse rock vai te conquistar!\n\n(Refr√£o)\n${theme.toUpperCase()}! Sinta o poder,\nRock'n'roll at√© amanhecer,\n${theme.toUpperCase()}! Vem com a gente,\nEssa banda √© diferente! ‚ô™\n\nüé∏ (Solo √©pico de guitarra!)`,
    
    pop: `üíø POP ${theme.toUpperCase()}\n\n‚ô™ La la la, la la la,\n${theme} me faz voar,\nMelodia chiclete grudando,\nImposs√≠vel n√£o dan√ßar!\n\nBrilha como estrela no c√©u,\nCores vibrantes como arco-√≠ris,\nEssa vibe contagiante,\nTodo mundo √© feliz!\n\n(Refr√£o)\n${theme.toUpperCase()}, voc√™ e eu,\nNessa vibe que aconteceu,\n${theme.toUpperCase()}, pura alegria,\nPop que contagia todo dia! ‚ô™\n\nüíø (Beat dan√ßante!)`,
    
    samba: `üé∫ SAMBA DO ${theme.toUpperCase()}\n\n‚ô™ √î lai√°, √¥ lai√°,\n${theme} no samba a balan√ßar,\nPandeiro batendo com maestria,\nCavaquinho tocando harmonia!\n\nTamborim fazendo o repique,\nSurdo marcando o compasso chique,\nNo balan√ßo brasileiro raiz,\nEsse samba deixa todo mundo feliz!\n\n(Refr√£o)\n${theme.toUpperCase()} no p√©,\nSamba que tem ax√©,\n${theme.toUpperCase()} a gingar,\nVem com a gente sambar! ‚ô™\n\nüé∫ (Swing brasileiro aut√™ntico!)`,
    
    funk: `üéπ FUNK DO ${theme.toUpperCase()}\n\n‚ô™ T√° t√° t√° tum tum,\n${theme} no funk, nenhum,\nGrave batendo forte na caixa,\nA pista toda se abaixa!\n\nSobe desce no movimento,\nSentindo o grave no momento,\nBatid√£o que n√£o tem fim,\nEssa vibe t√° on assim!\n\n(Refr√£o)\n${theme.toUpperCase()}, desce, sobe,\nO grave explode,\n${theme.toUpperCase()}, t√° bombando,\nO funkeiro t√° mandando! ‚ô™\n\nüéπ (Batid√£o de MTG!)`,
    
    sertanejo: `ü™ï SERTANEJO ${theme.toUpperCase()}\n\n‚ô™ Ai ai ai, cora√ß√£o,\n${theme} nessa can√ß√£o,\nViol√£o tocando suavemente,\nSentimento que a gente sente!\n\nNa mod√£o que emociona,\nVoz que ressoa e apaixona,\nEsse som raiz de verdade,\nTraz saudade e felicidade!\n\n(Refr√£o)\n${theme.toUpperCase()}, amor demais,\nSertanejo que a gente faz,\n${theme.toUpperCase()}, sem igual,\nM√≥d√£o sensacional! ‚ô™\n\nü™ï (Viola caipira raiz!)`,
    
    classica: `üéª CL√ÅSSICA ${theme.toUpperCase()}\n\n‚ô™ Em majestosas notas que ecoam,\n${theme} em melodias que soam,\nViolinos dan√ßando com gra√ßa,\nPiano tecendo uma trama que passa.\n\nOrquestra completa em harmonia,\nCrescendo que traz poesia,\nMovimento sublime e profundo,\nEmocionando todo o mundo!\n\n(Final)\n${theme.toUpperCase()} em sinfonia,\nArte pura, melodia,\n√ìpera que transcende,\nM√∫sica que compreende! ‚ô™\n\nüéª (Finale grandioso!)`
  };
  
  for (let key in songs) {
    if (style.includes(key)) {
      return songs[key];
    }
  }
  
  return `üéµ M√öSICA SOBRE ${theme.toUpperCase()}\n\n‚ô™ Uma melodia linda e envolvente,\nSobre ${theme} t√£o presente,\nNotas que tocam no cora√ß√£o,\nRitmo cheio de emo√ß√£o!\n\nCada acorde uma surpresa,\nCada verso com destreza,\nEssa m√∫sica especial,\n√â simplesmente sensacional! ‚ô™`;
}

// Responder ao usu√°rio
async function botRespond(msg) {
  try {
    let response = '';
    const msgLower = correctTypos(msg.toLowerCase().trim());
    
    // M√°quina de estados
    switch (conversationState) {
      case 'WAITING_NAME':
        const validName = validateName(msg);
        if (!validName) {
          response = "‚ùå Por favor, digite apenas letras no seu nome, sem n√∫meros ou caracteres especiais! Tente novamente: üòä";
        } else {
          userName = validName;
          localStorage.setItem('userName', userName);
          conversationState = 'IDLE';
          response = `Muito prazer, ${userName}! üéâ\n\nEstou aqui para ajudar com:\n‚Ä¢ C√°lculos matem√°ticos üßÆ\n‚Ä¢ Informa√ß√µes de clima üå°Ô∏è\n‚Ä¢ Hist√≥rias criativas üìñ\n‚Ä¢ M√∫sicas originais üéµ\n‚Ä¢ E muito mais!\n\nComo posso ajudar voc√™ hoje?`;
        }
        break;
        
      case 'WAITING_STORY_THEME':
        tempData.storyTheme = msgLower;
        conversationState = 'WAITING_STORY_DETAILS';
        response = "‚ú® Excelente escolha!\n\nAgora me conte os detalhes:\n\nQuem s√£o os personagens e o que acontece na hist√≥ria?\n\nExemplo:\n‚Ä¢ 'Jo√£o encontra Maria na praia'\n‚Ä¢ 'Pedro salva Ana do drag√£o'\n‚Ä¢ 'Luna descobre um portal m√°gico'\n\nSeja criativo! üé®";
        break;
        
      case 'WAITING_STORY_DETAILS':
        response = generateStory(tempData.storyTheme, msg);
        conversationState = 'IDLE';
        tempData = {};
        break;
        
      case 'WAITING_SONG_STYLE':
        tempData.songStyle = msgLower;
        conversationState = 'WAITING_SONG_THEME';
        response = "üé∂ Estilo escolhido!\n\nAgora me diga: sobre o que vai ser a m√∫sica?\n\nExemplos:\n‚Ä¢ Amor üíï\n‚Ä¢ Amizade ü§ù\n‚Ä¢ Festa üéâ\n‚Ä¢ Supera√ß√£o üí™\n‚Ä¢ Saudade üò¢\n‚Ä¢ Alegria üòÑ\n\nQual o tema? ‚ú®";
        break;
        
      case 'WAITING_SONG_THEME':
        response = generateSong(tempData.songStyle, msg);
        conversationState = 'IDLE';
        tempData = {};
        break;
        
      default:
        // Verificar c√°lculo
        if (isCalculation(msg)) {
          const calcResult = calcExpr(msg);
          if (calcResult) {
            response = calcResult;
          }
        }
        
        // Comandos normais
        if (!response) {
          if (msgLower.includes("temperatura") || msgLower.includes("clima") || msgLower.includes("tempo")) {
            let city = 'Fortaleza';
            const cityMatch = msg.match(/em\s+([a-zA-Z√Ä-√ø\s]+)|de\s+([a-zA-Z√Ä-√ø\s]+)/i);
            if (cityMatch) {
              city = (cityMatch[1] || cityMatch[2]).trim();
            }
            response = await getWeather(city);
          }
          else if (msgLower.includes('hist√≥ria') || msgLower.includes('historia') || msgLower.includes('conto')) {
            conversationState = 'WAITING_STORY_THEME';
            response = "üìñ Vou criar uma hist√≥ria incr√≠vel para voc√™!\n\nEscolha um tema:\n\nüíï Romance - Hist√≥rias de amor\nüè∞ Aventura - A√ß√£o e perigo\nüòÑ Com√©dia - Muita risada\nüëª Terror - Suspense arrepiante\nüêâ Fantasia - Magia e encantamento\n\nDigite o tema escolhido!";
          }
          else if (msgLower.includes('m√∫sica') || msgLower.includes('musica') || msgLower.includes('can√ß√£o')) {
            conversationState = 'WAITING_SONG_STYLE';
            response = "üéµ Vou criar uma m√∫sica especial!\n\nQue estilo musical voc√™ prefere?\n\nüé§ Rap - Flow e rima\nüé∏ Rock - Energia total\nüíø Pop - Melodia chiclete\nüé∫ Samba - Swing brasileiro\nüéπ Funk - Batid√£o pesado\nü™ï Sertanejo - Mod√£o raiz\nüéª Cl√°ssica - Orquestra\n\nDigite o estilo!";
          }
          else if (msgLower.includes('oi') || msgLower.includes('ol√°') || msgLower.includes('ola') || msgLower.includes('hey') || msgLower.includes('eai')) {
            if (userName) {
              const saudacoes = [
                `Oi, ${userName}! üëã Como vai voc√™?`,
                `Ol√°, ${userName}! üòä Tudo bem?`,
                `E a√≠, ${userName}! üéâ Pronto para uma conversa?`,
                `Fala, ${userName}! üöÄ No que posso ajudar?`
              ];
              response = saudacoes[Math.floor(Math.random() * saudacoes.length)];
            } else {
              response = "Ol√°! üëã Seja muito bem-vindo!\n\nEu sou seu assistente virtual e posso ajudar com muitas coisas!\n\nPara come√ßar, qual √© o seu nome? üòä";
              conversationState = 'WAITING_NAME';
            }
          }
          else if (msgLower.includes('hora') || msgLower.includes('horas')) {
            const now = new Date();
            const hora = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            response = `‚è∞ Agora s√£o exatamente ${hora}`;
          }
          else if (msgLower.includes('data') || msgLower.includes('dia')) {
            const now = new Date();
            const data = now.toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'});
            response = `üìÖ Hoje √© ${data}`;
          }
          else if (msgLower.includes('piada') || msgLower.includes('gra√ßa') || msgLower.includes('engra√ßado')) {
            const piadas = [
              "üòÇ Por que o livro de matem√°tica ficou triste?\nPorque ele tinha muitos problemas!",
              "üòÑ Por que o computador foi ao m√©dico?\nPorque estava com v√≠rus!",
              "ü§£ O que o zero disse para o oito?\nQue cinto maneiro!",
              "üòÜ Por que a galinha atravessou a estrada?\nPara chegar do outro lado!",
              "üòÇ Qual √© o contr√°rio de vol√°til?\nVem c√° sobrinho!",
              "ü§£ Por que o √°tomo foi preso?\nPorque ele agrediu com √≠ons!",
              "üòÑ O que o pato disse para a pata?\nVem qu√°!",
              "üòÜ Por que o elefante n√£o usa computador?\nPorque tem medo do mouse!"
            ];
            response = piadas[Math.floor(Math.random() * piadas.length)];
          }
          else if (msgLower.includes('obrigad') || msgLower.includes('valeu') || msgLower.includes('vlw')) {
            const respostas = [
              "üòä Por nada! Estou sempre aqui para ajudar!",
              "üéâ Disponha! √â um prazer ajudar voc√™!",
              "üíô Que isso! Conte comigo sempre!",
              "‚ú® Fico feliz em poder ajudar!"
            ];
            response = respostas[Math.floor(Math.random() * respostas.length)];
          }
          else if (msgLower.includes('tchau') || msgLower.includes('at√©') || msgLower.includes('adeus') || msgLower.includes('flw')) {
            const despedidas = [
              "üëã At√© logo! Volte sempre que precisar!",
              "üòä Tchau! Foi √≥timo conversar com voc√™!",
              "üéâ At√© a pr√≥xima! Estarei aqui quando precisar!",
              "üíô At√© breve! Cuide-se!"
            ];
            response = despedidas[Math.floor(Math.random() * despedidas.length)];
          }
          else if (msgLower.includes('quem criou') || msgLower.includes('quem fez') || msgLower.includes('sobre voc√™') || msgLower.includes('quem √© voc√™')) {
            response = "ü§ñ Sobre Mim:\n\nSou um assistente virtual desenvolvido pelo aluno Jo√£o Gabriel Marinho! üë®‚Äçüíª\n\nFui criado com tecnologias web modernas (HTML, CSS e JavaScript) e tenho v√°rias funcionalidades incr√≠veis:\n\n‚ú® Reconhecimento e s√≠ntese de voz\nüßÆ Calculadora avan√ßada\nüìñ Gerador de hist√≥rias criativas\nüéµ Compositor de m√∫sicas\nüå°Ô∏è Consulta de clima\nüíæ Mem√≥ria de conversas\n\nüë§ Criador: Jo√£o Gabriel Marinho\nüíª Tecnologias: HTML5, CSS3, JavaScript\n\nEstou aqui para ajudar, aprender e tornar sua experi√™ncia mais divertida! üöÄ";
          }
          else if (msgLower.includes('ajuda') || msgLower.includes('help') || msgLower.includes('comandos') || msgLower.includes('o que voc√™ faz')) {
            response = "üéØ Como posso ajudar:\n\nüßÆ C√ÅLCULOS:\n‚Ä¢ Digite opera√ß√µes: 50+50, 10*5\n‚Ä¢ Porcentagens: 20% de 100\n‚Ä¢ Avan√ßado: ‚àö25, 2^3, 5!\n\nüå°Ô∏è CLIMA:\n‚Ä¢ 'Qual a temperatura?'\n‚Ä¢ 'Clima em S√£o Paulo'\n\nüìñ HIST√ìRIAS:\n‚Ä¢ 'Conte uma hist√≥ria'\n‚Ä¢ Escolha tema e personagens\n\nüéµ M√öSICAS:\n‚Ä¢ 'Crie uma m√∫sica'\n‚Ä¢ Escolha estilo e tema\n\n‚è∞ UTILIT√ÅRIOS:\n‚Ä¢ Hora atual\n‚Ä¢ Data de hoje\n‚Ä¢ Piadas\n\nExperimente! üòä";
          }
          else if (!userName) {
            conversationState = 'WAITING_NAME';
            response = "üòä Ol√°! Para come√ßarmos, qual √© o seu nome?\n\n(Digite apenas letras, por favor!)";
          }
          else {
            const respostas = [
              `ü§î Hmm, n√£o entendi muito bem, ${userName}.\n\nTente perguntar sobre:\n‚Ä¢ Hora ou data\n‚Ä¢ Clima\n‚Ä¢ C√°lculos matem√°ticos\n‚Ä¢ Hist√≥rias criativas\n‚Ä¢ M√∫sicas originais\n‚Ä¢ Ou digite 'ajuda' para ver todos os comandos!`,
              `Desculpe, ${userName}, ainda estou aprendendo! üéì\n\nPosso ajudar com c√°lculos, clima, hist√≥rias, m√∫sicas e muito mais!\n\nQue tal tentar um dos bot√µes acima? üòä`,
              `N√£o entendi essa, ${userName}! üòÖ\n\nDigite 'ajuda' para ver tudo que eu posso fazer!`
            ];
            response = respostas[Math.floor(Math.random() * respostas.length)];
          }
        }
    }
    
    addMessage(response, 'bot');
  } catch (error) {
    console.error('Erro no bot:', error);
    addMessage("üòî Ops! Algo deu errado. Tente novamente!", 'bot');
  } finally {
    isProcessing = false;
    sendBtn.disabled = false;
  }
}
</script>
</body>
</html>
