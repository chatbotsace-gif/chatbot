<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistente Virtual</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
  background-size: 200% 200%;
  animation: gradientShift 15s ease infinite;
  color: #e2e8f0;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.header {
  padding: 16px 20px;
  background: linear-gradient(135deg, #1e40af, #3b82f6, #2563eb);
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.logo {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #60a5fa, #3b82f6);
  font-size: 22px;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
  animation: float 3s ease-in-out infinite;
  z-index: 1;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-5px); }
}

.header-title {
  flex: 1;
  z-index: 1;
}

.header-title h1 {
  font-size: 20px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.header-title p {
  font-size: 13px;
  opacity: 0.9;
  margin-top: 2px;
}

.status {
  font-size: 12px;
  padding: 6px 12px;
  border-radius: 20px;
  background: rgba(16, 185, 129, 0.25);
  border: 1px solid rgba(16, 185, 129, 0.4);
  z-index: 1;
  backdrop-filter: blur(10px);
}

.status-dot {
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
  display: inline-block;
  margin-right: 6px;
  animation: pulse 2s infinite;
  box-shadow: 0 0 8px #10b981;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.2); }
}

.quickActions {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 12px;
  background: rgba(15, 23, 42, 0.95);
  scrollbar-width: thin;
  border-bottom: 1px solid rgba(59, 130, 246, 0.2);
}

.quickActions::-webkit-scrollbar {
  height: 6px;
}

.quickActions::-webkit-scrollbar-thumb {
  background: rgba(59, 130, 246, 0.5);
  border-radius: 3px;
}

.quickActions button {
  padding: 10px 16px;
  border: none;
  border-radius: 20px;
  background: rgba(37, 99, 235, 0.25);
  color: #93c5fd;
  font-size: 13px;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.quickActions button:hover {
  background: rgba(59, 130, 246, 0.4);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.quickActions button:active {
  transform: translateY(0px);
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  padding-bottom: 120px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  scroll-behavior: smooth;
  position: relative;
}

.messages::-webkit-scrollbar {
  width: 8px;
}

.messages::-webkit-scrollbar-track {
  background: rgba(15, 23, 42, 0.5);
}

.messages::-webkit-scrollbar-thumb {
  background: rgba(59, 130, 246, 0.5);
  border-radius: 4px;
}

.msg-wrapper {
  display: flex;
  gap: 12px;
  animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.msg-wrapper.me {
  flex-direction: row-reverse;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.avatar.user {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
}

.avatar.bot {
  background: linear-gradient(135deg, #06b6d4, #0891b2);
}

.msg {
  padding: 12px 16px;
  border-radius: 18px;
  max-width: 75%;
  font-size: 14px;
  line-height: 1.6;
  word-wrap: break-word;
  white-space: pre-line;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.msg-wrapper.me .msg {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  color: #fff;
  border-bottom-right-radius: 4px;
}

.msg-wrapper.bot .msg {
  background: rgba(30, 41, 59, 0.9);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-bottom-left-radius: 4px;
  backdrop-filter: blur(10px);
}

.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #3b82f6;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.7;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}

.inputArea {
  display: flex;
  padding: 12px;
  gap: 10px;
  background: rgba(15, 23, 42, 0.98);
  border-top: 1px solid rgba(59, 130, 246, 0.3);
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100%;
  backdrop-filter: blur(15px);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
  z-index: 100;
}

.inputArea input {
  flex: 1;
  padding: 14px 18px;
  border-radius: 24px;
  border: 2px solid rgba(59, 130, 246, 0.4);
  background: rgba(30, 41, 59, 0.7);
  color: #e2e8f0;
  font-size: 14px;
  outline: none;
  transition: all 0.3s;
}

.inputArea input:focus {
  border-color: rgba(59, 130, 246, 0.8);
  background: rgba(30, 41, 59, 0.9);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.inputArea button {
  padding: 14px 20px;
  border: none;
  border-radius: 24px;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.inputArea button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
}

.inputArea button:active:not(:disabled) {
  transform: translateY(0px);
}

.inputArea button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#micBtn {
  background: linear-gradient(135deg, #10b981, #059669);
  min-width: 50px;
  font-size: 16px;
}

#micBtn.recording {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  animation: recordPulse 1s infinite;
}

@keyframes recordPulse {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
  }
  50% {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.8);
  }
}

.clear-btn {
  position: fixed;
  bottom: 100px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  transition: all 0.3s;
  z-index: 99;
}

.clear-btn:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
}

@media (max-width: 600px) {
  .msg {
    max-width: 85%;
  }
  
  .header-title h1 {
    font-size: 16px;
  }
  
  .header-title p {
    font-size: 11px;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="logo">ü§ñ</div>
  <div class="header-title">
    <h1>Assistente Virtual</h1>
    <p>Inteligente, r√°pido e divertido!</p>
  </div>
  <div class="status"><span class="status-dot"></span>Online</div>
</div>

<div class="quickActions">
  <button onclick="sendQuick('Oi')">üëã Saudar</button>
  <button onclick="sendQuick('Que horas s√£o?')">‚è∞ Hora</button>
  <button onclick="sendQuick('Qual a data?')">üìÖ Data</button>
  <button onclick="sendQuick('Me conte uma piada')">üòÑ Piada</button>
  <button onclick="sendQuick('50% de 200')">üßÆ Calcular</button>
  <button onclick="sendQuick('Qual a temperatura?')">üå°Ô∏è Clima</button>
  <button onclick="sendQuick('Conte uma hist√≥ria')">üìñ Hist√≥ria</button>
  <button onclick="sendQuick('Crie uma m√∫sica')">üéµ M√∫sica</button>
  <button onclick="sendQuick('Quem criou voc√™?')">‚ÑπÔ∏è Sobre</button>
</div>

<div id="messages" class="messages"></div>

<button class="clear-btn" onclick="clearChat()" title="Limpar chat">üóëÔ∏è</button>

<div class="inputArea">
  <input id="inputMsg" placeholder="Digite sua mensagem..." autocomplete="off">
  <button id="micBtn">üé§</button>
  <button id="sendBtn">Enviar</button>
</div>

<script>
const messagesEl = document.getElementById('messages');
const input = document.getElementById('inputMsg');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');

let userName = null;
let isProcessing = false;
let conversationState = 'IDLE';
let tempData = {};
let messageHistory = [];
let userLanguage = null;

const langMap = {
  'portugu√™s': 'pt', 'portugues': 'pt', 'portuguese': 'pt', 'pt': 'pt',
  'ingl√™s': 'en', 'ingles': 'en', 'english': 'en', 'en': 'en',
  'espanhol': 'es', 'espa√±ol': 'es', 'spanish': 'es', 'es': 'es',
  'franc√™s': 'fr', 'frances': 'fr', 'fran√ßais': 'fr', 'french': 'fr', 'fr': 'fr',
  'italiano': 'it', 'italian': 'it', 'it': 'it',
  'japon√™s': 'ja', 'japones': 'ja', 'japanese': 'ja', 'Êó•Êú¨Ë™û': 'ja', 'ja': 'ja'
};

const texts = {
  pt: {
    langSet: '‚úÖ Idioma definido: Portugu√™s! üáßüá∑',
    askName: 'Para come√ßarmos, qual √© o seu nome?',
    invalidName: 'Por favor, digite apenas letras no seu nome! Tente novamente:',
    niceMeet: 'Muito prazer',
    canHelp: 'Estou aqui para ajudar com:\n‚Ä¢ C√°lculos üßÆ\n‚Ä¢ Clima üå°Ô∏è\n‚Ä¢ Hist√≥rias üìñ\n‚Ä¢ M√∫sicas üéµ\n‚Ä¢ E muito mais!\n\nComo posso ajudar?',
    hi: 'Oi', howAre: 'Como vai?', time: 'Agora s√£o', date: 'Hoje √©',
    joke: 'Por que o livro de matem√°tica ficou triste?\nPorque tinha muitos problemas!',
    thanks: 'Por nada! Sempre aqui para ajudar!',
    bye: 'At√© logo! Volte sempre!',
    notUnder: 'N√£o entendi muito bem',
    tryAgain: 'Tente perguntar sobre hora, clima, piadas ou digite ajuda!',
    invalidLang: '‚ùå Idioma n√£o reconhecido. Escolha: Portugu√™s, English, Espa√±ol, Fran√ßais, Italiano ou Êó•Êú¨Ë™û',
    placeholder: 'Digite sua mensagem...',
    sendBtn: 'Enviar',
    clearConfirm: 'Deseja limpar todo o hist√≥rico?',
    clearMsg: 'Chat limpo! Como posso ajudar?',
    buttons: {
      greet: 'üëã Saudar',
      time: '‚è∞ Hora',
      date: 'üìÖ Data',
      joke: 'üòÑ Piada',
      calc: 'üßÆ Calcular',
      weather: 'üå°Ô∏è Clima',
      story: 'üìñ Hist√≥ria',
      music: 'üéµ M√∫sica',
      about: '‚ÑπÔ∏è Sobre'
    },
    quickMsg: {
      greet: 'Oi',
      time: 'Que horas s√£o?',
      date: 'Qual a data?',
      joke: 'Me conte uma piada',
      calc: '50% de 200',
      weather: 'Qual a temperatura?',
      story: 'Conte uma hist√≥ria',
      music: 'Crie uma m√∫sica',
      about: 'Quem criou voc√™?'
    }
  },
  en: {
    langSet: '‚úÖ Language set: English! üá∫üá∏',
    askName: 'To begin, what is your name?',
    invalidName: 'Please type only letters in your name! Try again:',
    niceMeet: 'Nice to meet you',
    canHelp: 'I can help with:\n‚Ä¢ Calculations üßÆ\n‚Ä¢ Weather üå°Ô∏è\n‚Ä¢ Stories üìñ\n‚Ä¢ Songs üéµ\n‚Ä¢ And more!\n\nHow can I help?',
    hi: 'Hi', howAre: 'How are you?', time: 'The time is', date: 'Today is',
    joke: 'Why don\'t scientists trust atoms?\nBecause they make up everything!',
    thanks: 'You\'re welcome! Always here to help!',
    bye: 'Goodbye! Come back anytime!',
    notUnder: 'I didn\'t quite understand',
    tryAgain: 'Try asking about time, weather, jokes or type help!',
    invalidLang: '‚ùå Language not recognized. Choose: Portugu√™s, English, Espa√±ol, Fran√ßais, Italiano or Êó•Êú¨Ë™û',
    placeholder: 'Type your message...',
    sendBtn: 'Send',
    clearConfirm: 'Do you want to clear all history?',
    clearMsg: 'Chat cleared! How can I help?',
    buttons: {
      greet: 'üëã Greet',
      time: '‚è∞ Time',
      date: 'üìÖ Date',
      joke: 'üòÑ Joke',
      calc: 'üßÆ Calculate',
      weather: 'üå°Ô∏è Weather',
      story: 'üìñ Story',
      music: 'üéµ Music',
      about: '‚ÑπÔ∏è About'
    },
    quickMsg: {
      greet: 'Hello',
      time: 'What time is it?',
      date: 'What\'s the date?',
      joke: 'Tell me a joke',
      calc: '50% of 200',
      weather: 'What\'s the weather?',
      story: 'Tell me a story',
      music: 'Create a song',
      about: 'Who created you?'
    }
  },
  es: {
    langSet: '‚úÖ Idioma configurado: ¬°Espa√±ol! üá™üá∏',
    askName: 'Para comenzar, ¬øcu√°l es tu nombre?',
    invalidName: '¬°Por favor, escribe solo letras en tu nombre! Int√©ntalo de nuevo:',
    niceMeet: 'Mucho gusto',
    canHelp: 'Puedo ayudar con:\n‚Ä¢ C√°lculos üßÆ\n‚Ä¢ Clima üå°Ô∏è\n‚Ä¢ Historias üìñ\n‚Ä¢ Canciones üéµ\n‚Ä¢ ¬°Y m√°s!\n\n¬øC√≥mo puedo ayudar?',
    hi: 'Hola', howAre: '¬øC√≥mo est√°s?', time: 'La hora es', date: 'Hoy es',
    joke: '¬øPor qu√© el libro de matem√°ticas estaba triste?\n¬°Porque ten√≠a muchos problemas!',
    thanks: '¬°De nada! ¬°Siempre aqu√≠ para ayudar!',
    bye: '¬°Adi√≥s! ¬°Vuelve pronto!',
    notUnder: 'No entend√≠ muy bien',
    tryAgain: '¬°Intenta preguntar sobre hora, clima, chistes o escribe ayuda!',
    invalidLang: '‚ùå Idioma no reconocido. Elige: Portugu√™s, English, Espa√±ol, Fran√ßais, Italiano o Êó•Êú¨Ë™û',
    placeholder: 'Escribe tu mensaje...',
    sendBtn: 'Enviar',
    clearConfirm: '¬øDeseas borrar todo el historial?',
    clearMsg: '¬°Chat limpio! ¬øC√≥mo puedo ayudar?',
    buttons: {
      greet: 'üëã Saludar',
      time: '‚è∞ Hora',
      date: 'üìÖ Fecha',
      joke: 'üòÑ Chiste',
      calc: 'üßÆ Calcular',
      weather: 'üå°Ô∏è Clima',
      story: 'üìñ Historia',
      music: 'üéµ M√∫sica',
      about: '‚ÑπÔ∏è Acerca'
    },
    quickMsg: {
      greet: 'Hola',
      time: '¬øQu√© hora es?',
      date: '¬øQu√© fecha es?',
      joke: 'Cu√©ntame un chiste',
      calc: '50% de 200',
      weather: '¬øCu√°l es la temperatura?',
      story: 'Cu√©ntame una historia',
      music: 'Crea una canci√≥n',
      about: '¬øQui√©n te cre√≥?'
    }
  },
  fr: {
    langSet: '‚úÖ Langue d√©finie: Fran√ßais! üá´üá∑',
    askName: 'Pour commencer, quel est votre nom?',
    invalidName: 'Veuillez taper uniquement des lettres! R√©essayez:',
    niceMeet: 'Enchant√©',
    canHelp: 'Je peux aider avec:\n‚Ä¢ Calculs üßÆ\n‚Ä¢ M√©t√©o üå°Ô∏è\n‚Ä¢ Histoires üìñ\n‚Ä¢ Chansons üéµ\n‚Ä¢ Et plus!\n\nComment puis-je aider?',
    hi: 'Salut', howAre: 'Comment allez-vous?', time: 'Il est', date: 'Aujourd\'hui c\'est',
    joke: 'Pourquoi les plongeurs plongent toujours en arri√®re?\nParce que sinon ils tombent dans le bateau!',
    thanks: 'Je vous en prie! Toujours l√† pour aider!',
    bye: 'Au revoir! Revenez bient√¥t!',
    notUnder: 'Je n\'ai pas bien compris',
    tryAgain: 'Essayez de demander l\'heure, la m√©t√©o, des blagues ou tapez aide!',
    invalidLang: '‚ùå Langue non reconnue. Choisissez: Portugu√™s, English, Espa√±ol, Fran√ßais, Italiano ou Êó•Êú¨Ë™û',
    placeholder: 'Tapez votre message...',
    sendBtn: 'Envoyer',
    clearConfirm: 'Voulez-vous effacer tout l\'historique?',
    clearMsg: 'Chat effac√©! Comment puis-je aider?',
    buttons: {
      greet: 'üëã Saluer',
      time: '‚è∞ Heure',
      date: 'üìÖ Date',
      joke: 'üòÑ Blague',
      calc: 'üßÆ Calculer',
      weather: 'üå°Ô∏è M√©t√©o',
      story: 'üìñ Histoire',
      music: 'üéµ Musique',
      about: '‚ÑπÔ∏è √Ä propos'
    },
    quickMsg: {
      greet: 'Bonjour',
      time: 'Quelle heure est-il?',
      date: 'Quelle est la date?',
      joke: 'Racontez-moi une blague',
      calc: '50% de 200',
      weather: 'Quelle est la temp√©rature?',
      story: 'Racontez-moi une histoire',
      music: 'Cr√©ez une chanson',
      about: 'Qui vous a cr√©√©?'
    }
  },
  it: {
    langSet: '‚úÖ Lingua impostata: Italiano! üáÆüáπ',
    askName: 'Per iniziare, qual √® il tuo nome?',
    invalidName: 'Per favore, digita solo lettere! Riprova:',
    niceMeet: 'Piacere',
    canHelp: 'Posso aiutare con:\n‚Ä¢ Calcoli üßÆ\n‚Ä¢ Meteo üå°Ô∏è\n‚Ä¢ Storie üìñ\n‚Ä¢ Canzoni üéµ\n‚Ä¢ E altro!\n\nCome posso aiutare?',
    hi: 'Ciao', howAre: 'Come stai?', time: 'Sono le', date: 'Oggi √®',
    joke: 'Cosa fa un gatto in un computer?\nMiao-usa!',
    thanks: 'Prego! Sempre qui per aiutare!',
    bye: 'Arrivederci! Torna presto!',
    notUnder: 'Non ho capito bene',
    tryAgain: 'Prova a chiedere ora, meteo, scherzi o scrivi aiuto!',
    invalidLang: '‚ùå Lingua non riconosciuta. Scegli: Portugu√™s, English, Espa√±ol, Fran√ßais, Italiano o Êó•Êú¨Ë™û',
    placeholder: 'Digita il tuo messaggio...',
    sendBtn: 'Invia',
    clearConfirm: 'Vuoi cancellare tutta la cronologia?',
    clearMsg: 'Chat cancellata! Come posso aiutare?',
    buttons: {
      greet: 'üëã Saluta',
      time: '‚è∞ Ora',
      date: 'üìÖ Data',
      joke: 'üòÑ Scherzo',
      calc: 'üßÆ Calcola',
      weather: 'üå°Ô∏è Meteo',
      story: 'üìñ Storia',
      music: 'üéµ Musica',
      about: '‚ÑπÔ∏è Info'
    },
    quickMsg: {
      greet: 'Ciao',
      time: 'Che ore sono?',
      date: 'Che data √®?',
      joke: 'Raccontami uno scherzo',
      calc: '50% di 200',
      weather: 'Qual √® la temperatura?',
      story: 'Raccontami una storia',
      music: 'Crea una canzone',
      about: 'Chi ti ha creato?'
    }
  },
  ja: {
    langSet: '‚úÖ Ë®ÄË™ûË®≠ÂÆö: Êó•Êú¨Ë™û! üáØüáµ',
    askName: '„ÅäÂêçÂâç„ÅØ‰Ωï„Åß„Åô„ÅãÔºü',
    invalidName: 'ÊñáÂ≠ó„ÅÆ„Åø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶:',
    niceMeet: '„ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶',
    canHelp: '„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Çã„Åì„Å®:\n‚Ä¢ Ë®àÁÆó üßÆ\n‚Ä¢ Â§©Ê∞ó üå°Ô∏è\n‚Ä¢ Áâ©Ë™û üìñ\n‚Ä¢ Êõ≤ üéµ\n‚Ä¢ „Åù„ÅÆ‰ªñ!\n\n‰Ωï„Çí„ÅäÊâã‰ºù„ÅÑ„Åó„Åæ„Åó„Çá„ÅÜ„ÅãÔºü',
    hi: '„Åì„Çì„Å´„Å°„ÅØ', howAre: '„ÅäÂÖÉÊ∞ó„Åß„Åô„ÅãÔºü', time: 'ÁèæÂú®', date: '‰ªäÊó•„ÅØ',
    joke: 'Êï∞Â≠¶„ÅÆÊú¨„ÅØ„Å™„ÅúÊÇ≤„Åó„Åã„Å£„Åü„Åß„Åô„ÅãÔºü\nÂïèÈ°å„Åå„Åü„Åè„Åï„Çì„ÅÇ„Å£„Åü„Åã„Çâ„Åß„ÅôÔºÅ',
    thanks: '„Å©„ÅÜ„ÅÑ„Åü„Åó„Åæ„Åó„Å¶ÔºÅ„ÅÑ„Å§„Åß„ÇÇÂä©„Åë„Åæ„ÅôÔºÅ',
    bye: '„Åï„Çà„ÅÜ„Å™„ÇâÔºÅ„Åæ„ÅüÊù•„Å¶„Åè„Å†„Åï„ÅÑÔºÅ',
    notUnder: '„Çà„ÅèÂàÜ„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü',
    tryAgain: 'ÊôÇÈñì„ÄÅÂ§©Ê∞ó„ÄÅ„Ç∏„Éß„Éº„ÇØ„ÇíËÅû„ÅÑ„Å¶„Åø„Çã„Åã„ÄÅ„Éò„É´„Éó„Å®ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ',
    invalidLang: '‚ùå Ë®ÄË™û„ÅåË™çË≠ò„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÈÅ∏Êäû: Portugu√™s, English, Espa√±ol, Fran√ßais, Italiano, Êó•Êú¨Ë™û',
    placeholder: '„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...',
    sendBtn: 'ÈÄÅ‰ø°',
    clearConfirm: '„Åô„Åπ„Å¶„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü',
    clearMsg: '„ÉÅ„É£„ÉÉ„Éà„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ‰Ωï„Çí„ÅäÊâã‰ºù„ÅÑ„Åó„Åæ„Åó„Çá„ÅÜ„ÅãÔºü',
    buttons: {
      greet: 'üëã Êå®Êã∂',
      time: '‚è∞ ÊôÇÈñì',
      date: 'üìÖ Êó•‰ªò',
      joke: 'üòÑ „Ç∏„Éß„Éº„ÇØ',
      calc: 'üßÆ Ë®àÁÆó',
      weather: 'üå°Ô∏è Â§©Ê∞ó',
      story: 'üìñ Áâ©Ë™û',
      music: 'üéµ Èü≥Ê•Ω',
      about: '‚ÑπÔ∏è ÊÉÖÂ†±'
    },
    quickMsg: {
      greet: '„Åì„Çì„Å´„Å°„ÅØ',
      time: '‰ΩïÊôÇ„Åß„Åô„ÅãÔºü',
      date: '‰ªäÊó•„ÅØ‰ΩïÊó•„Åß„Åô„ÅãÔºü',
      joke: '„Ç∏„Éß„Éº„ÇØ„ÇíÊïô„Åà„Å¶',
      calc: '200„ÅÆ50%',
      weather: 'Ê∞óÊ∏©„ÅØÔºü',
      story: 'Áâ©Ë™û„ÇíÊïô„Åà„Å¶',
      music: 'Êõ≤„Çí‰Ωú„Å£„Å¶',
      about: 'Ë™∞„Åå‰Ωú„Çä„Åæ„Åó„Åü„ÅãÔºü'
    }
  }
};

window.addEventListener('DOMContentLoaded', () => {
  if (messagesEl.children.length === 0) {
    const msg = "üëã Ol√°! Hello! ¬°Hola! Bonjour! Ciao! „Åì„Çì„Å´„Å°„ÅØ!\n\nüåç Selecione seu idioma / Select your language:\n\nüáßüá∑ Portugu√™s\nüá∫üá∏ English\nüá™üá∏ Espa√±ol\nüá´üá∑ Fran√ßais\nüáÆüáπ Italiano\nüáØüáµ Êó•Êú¨Ë™û";
    addMessage(msg, 'bot', false);
    conversationState = 'WAITING_LANGUAGE';
  }
});

function addMessage(text, who = 'bot', shouldSave = true) {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrapper ' + who;
  
  const avatar = document.createElement('div');
  avatar.className = 'avatar ' + (who === 'me' ? 'user' : 'bot');
  avatar.textContent = who === 'me' ? 'üë§' : 'ü§ñ';
  
  const msg = document.createElement('div');
  msg.className = 'msg';
  msg.textContent = text;
  
  wrap.appendChild(avatar);
  wrap.appendChild(msg);
  messagesEl.appendChild(wrap);
  
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  if (shouldSave) {
    messageHistory.push({ text, who });
    if (messageHistory.length > 50) messageHistory.shift();
  }
  
  if (who === 'bot') speak(text);
}

function showTyping() {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrapper bot typing-wrapper';
  wrap.innerHTML = '<div class="avatar bot">ü§ñ</div><div class="msg"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return wrap;
}

function removeTyping(el) {
  if (el && el.parentNode) el.parentNode.removeChild(el);
}

function updateUILanguage() {
  if (!userLanguage) return;
  const t = texts[userLanguage];
  
  // Atualizar placeholder do input
  input.placeholder = t.placeholder;
  
  // Atualizar bot√£o enviar
  sendBtn.textContent = t.sendBtn;
  
  // Atualizar bot√µes r√°pidos
  const quickBtns = document.querySelectorAll('.quickActions button');
  quickBtns[0].innerHTML = t.buttons.greet;
  quickBtns[0].onclick = () => sendQuick(t.quickMsg.greet);
  quickBtns[1].innerHTML = t.buttons.time;
  quickBtns[1].onclick = () => sendQuick(t.quickMsg.time);
  quickBtns[2].innerHTML = t.buttons.date;
  quickBtns[2].onclick = () => sendQuick(t.quickMsg.date);
  quickBtns[3].innerHTML = t.buttons.joke;
  quickBtns[3].onclick = () => sendQuick(t.quickMsg.joke);
  quickBtns[4].innerHTML = t.buttons.calc;
  quickBtns[4].onclick = () => sendQuick(t.quickMsg.calc);
  quickBtns[5].innerHTML = t.buttons.weather;
  quickBtns[5].onclick = () => sendQuick(t.quickMsg.weather);
  quickBtns[6].innerHTML = t.buttons.story;
  quickBtns[6].onclick = () => sendQuick(t.quickMsg.story);
  quickBtns[7].innerHTML = t.buttons.music;
  quickBtns[7].onclick = () => sendQuick(t.quickMsg.music);
  quickBtns[8].innerHTML = t.buttons.about;
  quickBtns[8].onclick = () => sendQuick(t.quickMsg.about);
}

function speak(text) {
  if (!window.speechSynthesis) return;
  try {
    speechSynthesis.cancel();
    const clean = text.replace(/[ü§ñüòäüëã‚è∞üìÖüòÑüßÆüå°Ô∏èüìñüéµüí°‚ú®üéâüèÜ‚öîÔ∏èüòÇüåôüëªüêâüíïüé§üé∏üíøüé∫üéπü™ï‚ùå‚úÖüáßüá∑üá∫üá∏üá™üá∏üá´üá∑üáÆüáπüáØüáµüåç]/g, '');
    const utter = new SpeechSynthesisUtterance(clean);
    utter.lang = 'pt-BR';
    utter.rate = 1.0;
    utter.pitch = 1.1;
    utter.volume = 0.8;
    speechSynthesis.speak(utter);
  } catch (e) {}
}

micBtn.addEventListener('click', () => {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    addMessage('‚ö†Ô∏è Navegador n√£o suporta voz!', 'bot');
    return;
  }
  const rec = new SR();
  rec.lang = 'pt-BR';
  rec.continuous = false;
  rec.interimResults = false;
  
  micBtn.classList.add('recording');
  micBtn.disabled = true;
  
  rec.onresult = (e) => {
    input.value = e.results[0][0].transcript;
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
    handleSend();
  };
  
  rec.onerror = () => {
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
    addMessage('‚ùå Erro no reconhecimento!', 'bot');
  };
  
  rec.onend = () => {
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
  };
  
  try { rec.start(); } catch (e) {
    micBtn.classList.remove('recording');
    micBtn.disabled = false;
  }
});

function sendQuick(text) {
  if (isProcessing) return;
  input.value = text;
  handleSend();
}

function handleSend() {
  const text = input.value.trim();
  if (!text || isProcessing) return;
  
  addMessage(text, 'me');
  input.value = '';
  
  isProcessing = true;
  sendBtn.disabled = true;
  
  const typing = showTyping();
  
  setTimeout(() => {
    removeTyping(typing);
    botRespond(text);
  }, 500 + Math.random() * 500);
}

sendBtn.addEventListener('click', handleSend);
input.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') handleSend();
});

function validateName(name) {
  name = name.trim();
  if (name.length < 2 || name.length > 50) return null;
  if (!/^[a-zA-Z√Ä-√ø\s]+$/.test(name)) return null;
  return name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
}

function calcExpr(expr) {
  try {
    const orig = expr;
    expr = expr.replace(/\s+/g, '');
    
    // Substituir s√≠mbolos especiais
    expr = expr.replace(/√ó/g, '*');
    expr = expr.replace(/√∑/g, '/');
    
    // Porcentagens em m√∫ltiplos idiomas
    // Portugu√™s: 20% de 100
    expr = expr.replace(/(\d+(?:\.\d+)?)%\s*de\s*(\d+(?:\.\d+)?)/gi, (m, p, n) => (parseFloat(n) * parseFloat(p) / 100).toString());
    // Ingl√™s: 20% of 100
    expr = expr.replace(/(\d+(?:\.\d+)?)%\s*of\s*(\d+(?:\.\d+)?)/gi, (m, p, n) => (parseFloat(n) * parseFloat(p) / 100).toString());
    // Espanhol: 20% de 100
    // Franc√™s: 20% de 100
    // Italiano: 20% di 100
    expr = expr.replace(/(\d+(?:\.\d+)?)%\s*di\s*(\d+(?:\.\d+)?)/gi, (m, p, n) => (parseFloat(n) * parseFloat(p) / 100).toString());
    // Japon√™s: 100„ÅÆ20%
    expr = expr.replace(/(\d+(?:\.\d+)?)[„ÅÆ„Éé](\d+(?:\.\d+)?)%/gi, (m, n, p) => (parseFloat(n) * parseFloat(p) / 100).toString());
    
    // Raiz quadrada
    expr = expr.replace(/‚àö(\d+(?:\.\d+)?)/g, (m, n) => Math.sqrt(parseFloat(n)));
    
    // Pot√™ncia
    expr = expr.replace(/(\d+(?:\.\d+)?)\^(\d+(?:\.\d+)?)/g, (m, b, e) => Math.pow(parseFloat(b), parseFloat(e)));
    
    // Fatorial
    expr = expr.replace(/(\d+)!/g, (match, n) => {
      let num = parseInt(n);
      if (num > 20) return 'Grande demais';
      if (num < 0) return 'Inv√°lido';
      let result = 1;
      for (let i = 1; i <= num; i++) {
        result *= i;
      }
      return result;
    });
    
    const result = Function('"use strict"; return (' + expr + ')')();
    if (isNaN(result) || !isFinite(result)) return null;
    const fmt = Number.isInteger(result) ? result : result.toFixed(2);
    return 'üßÆ ' + orig + ' = ' + fmt;
  } catch (e) {
    return null;
  }
}

function isCalc(msg) {
  const clean = msg.replace(/\s+/g, '');
  // Aceita n√∫meros e operadores em qualquer idioma
  return /^[\d+\-*/().‚àö^%√ó√∑]+$/.test(clean) || 
         msg.includes('calcular') || msg.includes('calculate') || msg.includes('calcular') || 
         msg.includes('calculer') || msg.includes('calcola') || msg.includes('Ë®àÁÆó') ||
         /%\s*(de|of|di|„ÅÆ)\s*\d+/.test(msg) || 
         /\d+[„ÅÆ„Éé]\d+%/.test(msg);
}

async function getWeather(city) {
  const weathers = {
    'fortaleza': { temp: 29, desc: 'c√©u limpo', hum: 70, wind: 22 },
    'sao paulo': { temp: 22, desc: 'nublado', hum: 65, wind: 12 },
    'default': { temp: 24, desc: 'parcialmente nublado', hum: 65, wind: 15 }
  };
  const w = weathers[city.toLowerCase()] || weathers['default'];
  return 'üå°Ô∏è Clima em ' + city + ':\nüå° ' + w.temp + '¬∞C\n‚òÅÔ∏è ' + w.desc + '\nüíß ' + w.hum + '%\nüí® ' + w.wind + ' km/h';
}

function generateStory(theme, details) {
  return 'üìñ ERA UMA VEZ...\n\n' + details + '\n\nE assim come√ßa uma hist√≥ria incr√≠vel cheia de aventuras emocionantes! ‚ú®';
}

function generateSong(style, theme) {
  return 'üéµ M√öSICA SOBRE ' + theme.toUpperCase() + '\n\n‚ô™ Uma melodia linda e envolvente,\nSobre ' + theme + ' t√£o presente,\nNotas que tocam no cora√ß√£o,\nRitmo cheio de emo√ß√£o! ‚ô™';
}

async function botRespond(msg) {
  try {
    let response = '';
    const lower = msg.toLowerCase().trim();
    const t = userLanguage ? texts[userLanguage] : texts['pt'];
    
    if (conversationState === 'WAITING_LANGUAGE') {
      const lang = langMap[lower];
      if (lang) {
        userLanguage = lang;
        conversationState = 'WAITING_NAME';
        updateUILanguage();
        response = texts[userLanguage].langSet + '\n\n' + texts[userLanguage].askName + ' üòä';
      } else {
        response = t.invalidLang;
      }
    }
    else if (conversationState === 'WAITING_NAME') {
      const valid = validateName(msg);
      if (!valid) {
        response = '‚ùå ' + t.invalidName + ' üòä';
      } else {
        userName = valid;
        conversationState = 'IDLE';
        response = t.niceMeet + ', ' + userName + '! üéâ\n\n' + t.canHelp;
      }
    }
    else if (conversationState === 'WAITING_STORY_THEME') {
      tempData.storyTheme = lower;
      conversationState = 'WAITING_STORY_DETAILS';
      response = '‚ú® Agora me conte os detalhes da hist√≥ria:';
    }
    else if (conversationState === 'WAITING_STORY_DETAILS') {
      response = generateStory(tempData.storyTheme, msg);
      conversationState = 'IDLE';
      tempData = {};
    }
    else if (conversationState === 'WAITING_SONG_STYLE') {
      tempData.songStyle = lower;
      conversationState = 'WAITING_SONG_THEME';
      response = 'üé∂ Sobre o que vai ser a m√∫sica?';
    }
    else if (conversationState === 'WAITING_SONG_THEME') {
      response = generateSong(tempData.songStyle, msg);
      conversationState = 'IDLE';
      tempData = {};
    }
    else {
      if (isCalc(msg)) {
        const calc = calcExpr(msg);
        if (calc) response = calc;
      }
      
      if (!response) {
        if (lower.includes('clima') || lower.includes('temperatura') || lower.includes('weather')) {
          response = await getWeather('Fortaleza');
        }
        else if (lower.includes('hist√≥ria') || lower.includes('historia') || lower.includes('story')) {
          conversationState = 'WAITING_STORY_THEME';
          response = 'üìñ Escolha um tema: romance, aventura, com√©dia, terror ou fantasia';
        }
        else if (lower.includes('m√∫sica') || lower.includes('musica') || lower.includes('music')) {
          conversationState = 'WAITING_SONG_STYLE';
          response = 'üéµ Escolha um estilo: rap, rock, pop, samba, funk, sertanejo';
        }
        else if (lower.includes('oi') || lower.includes('ol√°') || lower.includes('hello') || lower.includes('hi') || lower.includes('hola') || lower.includes('bonjour') || lower.includes('ciao')) {
          response = userName ? t.hi + ', ' + userName + '! üëã ' + t.howAre : t.askName + ' üòä';
          if (!userName) conversationState = 'WAITING_NAME';
        }
        else if (lower.includes('hora') || lower.includes('time') || lower.includes('heure')) {
          const now = new Date();
          const hora = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
          response = '‚è∞ ' + t.time + ' ' + hora;
        }
        else if (lower.includes('data') || lower.includes('date') || lower.includes('dia') || lower.includes('day')) {
          const now = new Date();
          const data = now.toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'});
          response = 'üìÖ ' + t.date + ' ' + data;
        }
        else if (lower.includes('piada') || lower.includes('joke') || lower.includes('chiste') || lower.includes('blague')) {
          response = 'üòÇ ' + t.joke;
        }
        else if (lower.includes('obrigad') || lower.includes('thank') || lower.includes('graci') || lower.includes('merci')) {
          response = 'üòä ' + t.thanks;
        }
        else if (lower.includes('tchau') || lower.includes('bye') || lower.includes('adios') || lower.includes('au revoir')) {
          response = 'üëã ' + t.bye;
        }
        else if (lower.includes('criou') || lower.includes('created') || lower.includes('cre√≥')) {
          response = 'ü§ñ Sobre Mim:\n\nSou um assistente virtual desenvolvido pelo aluno Jo√£o Gabriel Marinho! üë®‚Äçüíª\n\nFui criado com tecnologias web modernas (HTML, CSS e JavaScript) e tenho v√°rias funcionalidades incr√≠veis:\n\n‚ú® Reconhecimento e s√≠ntese de voz\nüßÆ Calculadora avan√ßada\nüìñ Gerador de hist√≥rias criativas\nüéµ Compositor de m√∫sicas\nüå°Ô∏è Consulta de clima\nüíæ Mem√≥ria de conversas\nüåç Suporte multil√≠ngue (6 idiomas)\n\nüë§ Criador: Jo√£o Gabriel Marinho\nüíª Tecnologias: HTML5, CSS3, JavaScript\n\nEstou aqui para ajudar, aprender e tornar sua experi√™ncia mais divertida! üöÄ';
        }
        else if (lower.includes('ajuda') || lower.includes('help') || lower.includes('ayuda') || lower.includes('aide')) {
          response = 'üéØ Posso ajudar com:\n‚Ä¢ C√°lculos üßÆ\n‚Ä¢ Clima üå°Ô∏è\n‚Ä¢ Hist√≥rias üìñ\n‚Ä¢ M√∫sicas üéµ\n‚Ä¢ Hora e Data ‚è∞\n‚Ä¢ Piadas üòÑ';
        }
        else if (!userName) {
          conversationState = 'WAITING_NAME';
          response = 'üòä ' + t.askName;
        }
        else {
          response = 'ü§î ' + t.notUnder + ', ' + userName + '.\n\n' + t.tryAgain;
        }
      }
    }
    
    addMessage(response, 'bot');
  } catch (error) {
    console.error('Erro:', error);
    addMessage('üòî Ops! Algo deu errado!', 'bot');
  } finally {
    isProcessing = false;
    sendBtn.disabled = false;
  }
}
</script>
</body>
</html>
